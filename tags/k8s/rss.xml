<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>titaneric - k8s</title>
      <link>https://www.titaneric.com</link>
      <description></description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://www.titaneric.com/tags/k8s/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Wed, 18 Jun 2025 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Grafana Loki系列文章(II) - Loki寫入及讀取性能調校</title>
          <pubDate>Wed, 18 Jun 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/</link>
          <guid>https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/</guid>
          <description xml:base="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/">&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;7ebbf0334cc14d71818a451b89847db8.png?updatedAt=1739524743000&quot; alt=&quot;&quot; &#x2F;&gt;
&lt;em&gt;&lt;p style=&quot;text-align:center&quot;&gt;Generated by Microsoft Designer&lt;&#x2F;p&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;bei-jing&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#bei-jing&quot; aria-label=&quot;Anchor link for: bei-jing&quot;&gt;背景&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;在&lt;a href=&quot;https:&#x2F;&#x2F;www.titaneric.com&#x2F;posts&#x2F;grafana-loki-upgrade-1-zh&#x2F;&quot;&gt;前一篇Loki系列文章&lt;&#x2F;a&gt;中，提到我們利用金絲雀部署的方式，利用Vector複製真實環境的log送往新版Loki，在此同時調整Loki config進行效能調校，直到結果滿意之後，再開放給團隊使用。
因為我們的Loki是使用分散式模式部署，涉及多個功能不同的component，使得Loki架構非常複雜，在調整細項config之前，要非常清楚了解各個component間的關係，才能依序並且合理的調整config。&lt;&#x2F;p&gt;
&lt;p&gt;在調教Loki時，可以先針對&lt;strong&gt;寫入&lt;&#x2F;strong&gt;相關的component做調整，例如ingester及distributor，甚至是在前一篇文章中的提及的log collector，目標是&lt;strong&gt;讓寫入的chunk的Flush Reason盡可能是Full，避免碎片化chunk&lt;&#x2F;strong&gt;的問題。不僅能夠在空間上更有效率的存放，也同時能夠間接的影響query速度。&lt;&#x2F;p&gt;
&lt;p&gt;原因是相比於碎片化的chunk，滿載的chunk代表我們僅需更少數量的chunk，就能表示相同的log量，最終導致Loki在建立chunk的index也跟著減少。在查詢這些log時，Loki會依照query內容去查index，因為查到index後得知這些chunk數量是少的，也就花費更少的時間讀取chunk內容，讓querier可以專注在執行面，減少整體query時間開銷。&lt;&#x2F;p&gt;
&lt;p&gt;所以，我們花費大量的時間調校Loki的寫入效能，進而調整讀取效能，以下文章會分別針對寫入以及讀取，詳細說明各項config調整內容。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;loki-write-configdiao-zheng&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loki-write-configdiao-zheng&quot; aria-label=&quot;Anchor link for: loki-write-configdiao-zheng&quot;&gt;Loki write config調整&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;ingester&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ingester&quot; aria-label=&quot;Anchor link for: ingester&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#ingester&quot;&gt;ingester&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;ingester.chunk-encoding&lt;&#x2F;code&gt;：直接設定成&lt;code&gt;snappy&lt;&#x2F;code&gt;，跟&lt;code&gt;gzip&lt;&#x2F;code&gt;相比雖然不是最大的壓縮比，但是速度較快，壓縮比也還能接受，&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;bp-configure&#x2F;#use-snappy-compression-algorithm&quot;&gt;官方config&lt;&#x2F;a&gt;以及&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;28&#x2F;the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance&#x2F;&quot;&gt;官方blog&lt;&#x2F;a&gt;也推薦使用。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;shard-streams.enabled&lt;&#x2F;code&gt;：在調整Loki labels後，stream數量會變少，但是每一條stream的log量會變大，可能會超過&lt;code&gt;ingester.per-stream-rate-limit&lt;&#x2F;code&gt;限制造成rate limit。開啟這個參數以後，如果某一條stream量超過&lt;code&gt;shard-streams.desired-rate&lt;&#x2F;code&gt;，會被分成多個stream shard，distributor會自動為這些stream shard加上&lt;code&gt;__stream_shard__&lt;&#x2F;code&gt; label，邏輯上會變成不同的stream，讓ingester有能力消化這些log。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.per-stream-rate-limit&lt;&#x2F;code&gt;：如果開啟&lt;code&gt;shard-streams.enabled&lt;&#x2F;code&gt;還是會碰到rate limit，在ingester資源充足前提下，可以上調這個數值。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.ingestion-rate-limit-mb&lt;&#x2F;code&gt;：可以參考&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;grafana&#x2F;loki&#x2F;blob&#x2F;main&#x2F;production&#x2F;loki-mixin-compiled&#x2F;dashboards&#x2F;loki-operational.json&quot;&gt;Loki Operational Dashboard&lt;&#x2F;a&gt;中MBs Per Tenant Panel裡的語法，並使用PromQL加總每一個tenant的log量，進而計算出合理的全局rate limit，&lt;code&gt;distributor.ingestion-burst-size-mb&lt;&#x2F;code&gt;需要也可以一併更新。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;9d552b04f6b44e3c87479a629f9cef4d.png?updatedAt=1750326304000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.max-chunk-age&lt;&#x2F;code&gt;：雖然&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2021&#x2F;02&#x2F;16&#x2F;the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki&#x2F;&quot;&gt;官方blog&lt;&#x2F;a&gt;曾建議將這個數值設定成&lt;code&gt;2h&lt;&#x2F;code&gt;，不過按照前一篇提及的方法調整過Loki labels後，我們將這數值上調到&lt;code&gt;4h&lt;&#x2F;code&gt;。同時，&lt;code&gt;ingester.chunks-idle-period&lt;&#x2F;code&gt;也調整成&lt;code&gt;4h&lt;&#x2F;code&gt;。我們刻意多等待2小時，讓一次性任務或是排程的log streams能利用這段時間寫到相同的chunk，讓Chunk Flush Reason更有機會從&lt;strong&gt;max age&lt;&#x2F;strong&gt;轉成&lt;strong&gt;full&lt;&#x2F;strong&gt;。另一個帶來的效益是如同&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2024&#x2F;01&#x2F;04&#x2F;the-concise-guide-to-loki-how-to-work-with-out-of-order-and-older-logs&#x2F;&quot;&gt;官方 blog&lt;&#x2F;a&gt;提及的，我們能接受更早的out-of-order ingestion，這對我們非常有幫助，如果我們在Vector config有瑕疵，誤送一些錯誤處理的log到Loki去，多出來的這段時間能幫助我們排障，即時處理完後讓Loki不要因為out-of-order拒絕接受log。最後，雖然上調這個參數會小幅度的增加ingester記憶體使用，但這遠小於調整Loki labels節省的量，所以是可以接受的。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.readiness-check-ring-health&lt;&#x2F;code&gt;：如果ingester的replica一多，在重啟 ingester statefulset時候預設會去檢查ingester ring上的健康程度，這時光是等待單顆ingester可能就消耗10分鐘，可以考慮將這數值改成false，僅檢查ingester自己的健康狀態，減少等待時間到&lt;strong&gt;2分鐘&lt;&#x2F;strong&gt;。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.zone-awareness-enabled&lt;&#x2F;code&gt;：這個參數已經在&lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart的&lt;code&gt;ingester.zoneAwareReplication&lt;&#x2F;code&gt;有良好的封裝。如同以下例子，只要指定ingester的replica數量以及affinity，就能將不同的ingester&lt;strong&gt;平均&lt;&#x2F;strong&gt;部到不同的AZ，達成更高可用性的寫入。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;ingester&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;replicas&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;12
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneAwareReplication&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneA&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;extraAffinity&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;nodeAffinity&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;nodeSelectorTerms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;matchExpressions&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;nodepool
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;operator&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;In
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;values&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;availability-zone
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;operator&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;In
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;values&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;az-1
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneB&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneC&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;distributor&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#distributor&quot; aria-label=&quot;Anchor link for: distributor&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#distributor&quot;&gt;distributor&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;distributor.client-cleanup-period&lt;&#x2F;code&gt;：在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;get-started&#x2F;components&#x2F;#rate-limiting&quot;&gt;Loki架構&lt;&#x2F;a&gt;中，distributor會每隔一段時間，向ingester要每一條stream的log量，當作rate limit的參考。另外，distributor會每隔&lt;code&gt;distributor.client-cleanup-period&lt;&#x2F;code&gt;進行client的更新，移除不存在的ingester連線。在重啟ingester過程中，distributor如果沒有即時更新ingester連線，就有可能會誤送log給不存在的ingester。可以考慮縮減這段時間，更快移除這些不健康的連線避免錯誤。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.rate-store.ingester-request-timeout&lt;&#x2F;code&gt;：如果因為網路的不穩定，造成distributor向ingester的請求時間較長造成timeout，可以稍微增加這個數值，避免distributor發生錯誤。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;loki-read-configdiao-zheng&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loki-read-configdiao-zheng&quot; aria-label=&quot;Anchor link for: loki-read-configdiao-zheng&quot;&gt;Loki read config調整&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;querier&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#querier&quot; aria-label=&quot;Anchor link for: querier&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#querier&quot;&gt;querier&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;關於Loki querier的調整可以直接參考&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;28&#x2F;the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance&#x2F;&quot;&gt;官方blog&lt;&#x2F;a&gt;的詳細說明，作者特別使用精美的動畫說明querier相關的參數是如何影響query行為，也提供了各類metrics幫助Loki管理者發現當前問題。&lt;&#x2F;p&gt;
&lt;p&gt;在blog中，我覺得對調整最有幫助的是以下的LogQL語法(已依據使用情境做些調整)。&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#fafafa;color:#61676c;&quot;&gt;&lt;code&gt;&lt;span&gt;{component=&amp;quot;querier&amp;quot;, cluster=&amp;quot;$cluster&amp;quot;, namespace=&amp;quot;$namespace&amp;quot;} 
&lt;&#x2F;span&gt;&lt;span&gt;  |= &amp;quot;metrics.go&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  | logfmt
&lt;&#x2F;span&gt;&lt;span&gt;  | latency=&amp;quot;slow&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  | query_type=&amp;quot;metric&amp;quot; or query_type=&amp;quot;filter&amp;quot; or query_type=&amp;quot;limited&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format 
&lt;&#x2F;span&gt;&lt;span&gt;      duration_s=`{{.duration | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      queue_time_s=`{{.queue_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunk_refs_s=`{{.chunk_refs_fetch_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunk_total_s=`{{.store_chunks_download_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      cache_download_chunk_s=`{{.cache_chunk_download_time | duration}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format total_time_s=`{{addf .queue_time_s .duration_s}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format        
&lt;&#x2F;span&gt;&lt;span&gt;      queue_pct=`{{mulf (divf .queue_time_s .total_time_s) 100 }}`,
&lt;&#x2F;span&gt;&lt;span&gt;      index_pct=`{{mulf (divf (.chunk_refs_fetch_time | duration) .total_time_s) 100 }}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunks_pct=`{{mulf (divf .chunk_total_s .total_time_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      execution_pct=`{{mulf (divf (subf .duration_s .chunk_refs_s .chunk_total_s) .total_time_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      cache_download_pct=`{{mulf (divf .cache_download_chunk_s .chunk_total_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      avg_chunk_size=`{{divf (divf (bytes .total_bytes) .cache_chunk_req 1000)}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | line_format `| total_time {{printf &amp;quot;%3.0f&amp;quot; (.total_time_s | float64)}}s | queued {{printf &amp;quot;%3.0f&amp;quot; (.queue_pct | float64)}}% | execution {{printf &amp;quot;%3.0f&amp;quot; (.execution_pct | float64)}}% | index {{printf &amp;quot;%3.0f&amp;quot; (.index_pct | float64)}}% | store {{printf &amp;quot;%3.0f&amp;quot; (.chunks_pct | float64)}}% (cache {{ printf &amp;quot;%3.0f&amp;quot; (.cache_download_pct | float64) }}%) | avg_chunk {{printf &amp;quot;%3.0f&amp;quot; (.avg_chunk_size | float64)}}kB | {{ .query }}`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;他會呈現發生slow query（執行時間大於10秒）時，querier在執行subquery時，在4個不同的phase所花費的時間:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;queued&lt;&#x2F;strong&gt;：在queue中等待的時間&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;index&lt;&#x2F;strong&gt;：根據Loki label查index花費時間&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;store&lt;&#x2F;strong&gt;：拿到index後，從cache或object storage拿chunk時間&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;execution&lt;&#x2F;strong&gt;：取得chunk後，在querier中執行的時間&lt;&#x2F;p&gt;
&lt;p&gt;我們應盡可能讓&lt;strong&gt;execution&lt;&#x2F;strong&gt;比率愈高愈好（超過80%），因為這代表querier真正花費CPU時間計算結果，而不是在等待IO，如果發現query時間花在其他的phase，blog也有提到如何做對應的調整，在此不再贅述。&lt;&#x2F;p&gt;
&lt;p&gt;除此之外，我們特別調整&lt;strong&gt;store&lt;&#x2F;strong&gt;的呈現，多一個&lt;strong&gt;cache&lt;&#x2F;strong&gt;代表querier在拿chunk時，在cache中花費的時間，這個比率應該盡可能接近100%，代表拿chunk的時間主要花費在更快的cache，而不是慢得多的object storage。這對我們非常有幫助，讓我們發現先前的chunk cache是非常沒有效率的，需要額外調校，在之後會說明。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;chunk-cache&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#chunk-cache&quot; aria-label=&quot;Anchor link for: chunk-cache&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#chunk_store_config&quot;&gt;chunk cache&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;如果有讀過&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;08&#x2F;23&#x2F;how-we-scaled-grafana-cloud-logs-memcached-cluster-to-50tb-and-improved-reliability&#x2F;&quot;&gt;這篇官方blog&lt;&#x2F;a&gt;，一定會覺得如果Loki的chunk cache改成Memcached，並使用&lt;code&gt;extstore&lt;&#x2F;code&gt;掛載快速的SSD，能用更多的空間以及相對便宜的成本，為Loki query帶來極高的效能。我們也像文章中一樣嘗試計算現有的LogQL查詢區間熱區，文章中並沒有提及實際的query語法，不過我們是使用以下LogQL搭配熱力圖呈現。&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#fafafa;color:#61676c;&quot;&gt;&lt;code&gt;&lt;span&gt;sum_over_time({cluster=&amp;quot;$cluster&amp;quot;, namespace=&amp;quot;$namespace&amp;quot;, app=&amp;quot;loki&amp;quot;, component=&amp;quot;query-frontend&amp;quot;} |= &amp;quot;metrics.go&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  |= &amp;quot;query_type&amp;quot; | logfmt | query_type=&amp;quot;metric&amp;quot; or query_type=&amp;quot;filter&amp;quot; or query_type=&amp;quot;limited&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  | unwrap duration(start_delta)[5m])
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;由下圖可以看到，大部分的查詢區間都落在過去9小時以內。在討論後我們最後決定cache應至少能保留過去一天的chunk，進而計算cache需要的空間。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;8df2bccc2f424c3e9be76978042895e2.png?updatedAt=1750326446000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;當時我們舊的Loki是使用Redis當作chunk cache，剛好目前的&lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart已經針對Memcached有良好封裝，我們決定直接為新的Loki套用這些設定。然而，我們發現結果不如預期。&lt;&#x2F;p&gt;
&lt;p&gt;利用前述的LogQL語法，我們發現querier花了30%以上的時間在&lt;strong&gt;store&lt;&#x2F;strong&gt; phase，而且我們特別新增的&lt;strong&gt;cache&lt;&#x2F;strong&gt; phase比率不到50%，這代表我們不僅花費時間在等待chunk下載，而且在cache以及object storage都耗費了大量時間。這與我們預期的接近100% &lt;strong&gt;cache&lt;&#x2F;strong&gt; phase比率及極少的&lt;strong&gt;store&lt;&#x2F;strong&gt; phase比率大相徑庭。&lt;&#x2F;p&gt;
&lt;p&gt;在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;community.grafana.com&#x2F;t&#x2F;enabling-loki-jaeger-tracing&#x2F;51483&quot;&gt;開啟Loki的Jaeger tracing功能&lt;&#x2F;a&gt;以後，我們發現querier光是拿chunk cache花了超過10s，再加上&lt;strong&gt;execution&lt;&#x2F;strong&gt; phase所花費時間，經常會遇到timeout問題。&lt;&#x2F;p&gt;
&lt;p&gt;我們最終很幸運地在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;memcached&#x2F;memcached&#x2F;wiki&#x2F;ConfiguringLokiExtstore&quot;&gt;memcached官方GitHub&lt;&#x2F;a&gt;找到解方，以下是官方建議的memcached設定：
讓&lt;code&gt;ingester.chunk-target-size&lt;&#x2F;code&gt; 以及在memcached的max item size (&lt;code&gt;-I&lt;&#x2F;code&gt;參數)不要太大，可以設定成&lt;code&gt;2MB&lt;&#x2F;code&gt;，同時在memcached加上extstore特別的參數。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;memcached&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -m&lt;&#x2F;span&gt;&lt;span&gt; 6000&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -I&lt;&#x2F;span&gt;&lt;span&gt; 2m &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;	-o&lt;&#x2F;span&gt;&lt;span&gt; ext_path=&#x2F;disk&#x2F;extstore:500G,ext_wbuf_size=32,ext_threads=10,ext_max_sleep=10000,slab_automove_freeratio=0.10,ext_recache_rate=0
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;另外在loki設定中，應設定不大的batch size及parallelism，並且拉高timeout。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.batchsize&lt;&#x2F;code&gt;意思是memcached client一次拿多少個memcached keys，可以設定成memcached server的2倍數量。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.parallelism&lt;&#x2F;code&gt;目的是同時有多少的go routine是取得memcached keys，盡可能設定愈低的值，但如果網路頻寬允許的話可以拉高。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.timeout&lt;&#x2F;code&gt;的時間包含memcached拿cache，以及serialization的時間，如果chunk的item size一大，或是batch size大的話會影響timeout時間。預設是&lt;code&gt;100ms&lt;&#x2F;code&gt;但強烈建議調整成較高的值例如&lt;code&gt;60s&lt;&#x2F;code&gt;。&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Loki&#x27;s memcache client timeout is measuring the amount of time to &lt;em&gt;fetch and read and process the entire batch of keys from each host&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;code&gt;store.background.write-back-concurrency&lt;&#x2F;code&gt;代表寫入memcached的go routine數量，建議調整成1，避免太積極地寫入memcached，造成一些item被evict。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yml &quot;&gt;&lt;code class=&quot;language-yml&quot; data-lang=&quot;yml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;chunk_store_config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;chunk_cache_config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;memcached&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;batch_size&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;3
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;parallelism&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;2
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;memcached_client&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;addresses&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;127.0.0.1:11211
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;timeout&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;60s
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;background&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_goroutines&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_buffer&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;1000
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_size_limit&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;500MB
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;cheng-guo&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cheng-guo&quot; aria-label=&quot;Anchor link for: cheng-guo&quot;&gt;成果&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;write-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#write-performance&quot; aria-label=&quot;Anchor link for: write-performance&quot;&gt;Write performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;在下圖中，可以看到因為ingester在寫入log效能足夠，搭配適當的調節distributor的rate limit以及shard-streams，讓Loki不再因為rate limit問題，在distributor端拋棄送進來的log。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;9b3cf57812b44d2dab95e0dc953a2047.png?updatedAt=1750326529000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h3 id=&quot;query-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#query-performance&quot; aria-label=&quot;Anchor link for: query-performance&quot;&gt;Query performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;下圖是在前面的介紹到修改過後的官方LogQL執行結果，可以看到就算是slow subquery的執行，在&lt;strong&gt;execution&lt;&#x2F;strong&gt; phase執行時間佔比還是高達90%以上，而且在&lt;strong&gt;cache&lt;&#x2F;strong&gt;部分的佔比，更高達95%以上，這印證了chunk主要從cache中拿到，省下來的時間可以執行計算LogQL最後結果。&lt;&#x2F;p&gt;
&lt;p&gt;事實上在&lt;strong&gt;execution&lt;&#x2F;strong&gt; phase還有調整的空間，有機會透過增加querier replicas數量、調升CPU資源或是改善LogQL語法來更近一步加速搜尋時間。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;0bd7beb9a0124ea0bda1d474e06d1577.png?updatedAt=1750326541000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;下方是query花費時間隨時間的關係圖。黃線是第99百分位、橘線是第90百分位。可以看到query時間絕大部分都少於10s。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;2596fdc70a26474ab054f0f1e2713906.png?updatedAt=1750326553000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h3 id=&quot;cache-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cache-performance&quot; aria-label=&quot;Anchor link for: cache-performance&quot;&gt;Cache performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;在chunk cache部分，hit rate大部分時間都維持70%以上，這樣Loki可以避免再向慢得多的Object Storage拿需要的chunk，也減輕Object Storage的負擔。&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;5b6c5c0beb504dceb2a4d8e3de6fe7af.png?updatedAt=1750326563000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;jie-lun&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#jie-lun&quot; aria-label=&quot;Anchor link for: jie-lun&quot;&gt;結論&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;在這篇文章中，我們將重點著重在Loki的config調整。先是說明為何應該優先調整寫入效能，因為會連帶影響讀取效能。再帶到在Loki中負責寫入以及讀取的component細節config設定。過程中特別感謝Grafana以及Memcached提供的技術文章，提供給我們調整上的指引。&lt;&#x2F;p&gt;
&lt;p&gt;最後的成效是在寫入時，能盡可能接收log collector送來的log，在查詢上也能充分應用cache，減少Object Storage負擔，效果是令人滿意的。我們今後也會持續針對log collector以及Loki效能做精進，提供Loki的使用者更好的使用者體驗。&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Grafana Loki Series (II) - Tuning Loki Write and Read Performance</title>
          <pubDate>Wed, 18 Jun 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/grafana-loki-upgrade-2/</link>
          <guid>https://www.titaneric.com/posts/grafana-loki-upgrade-2/</guid>
          <description xml:base="https://www.titaneric.com/posts/grafana-loki-upgrade-2/">&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;7ebbf0334cc14d71818a451b89847db8.png?updatedAt=1739524743000&quot; alt=&quot;&quot; &#x2F;&gt;
&lt;em&gt;&lt;p style=&quot;text-align:center&quot;&gt;Generated by Microsoft Designer&lt;&#x2F;p&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;background&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#background&quot; aria-label=&quot;Anchor link for: background&quot;&gt;Background&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;In the &lt;a href=&quot;https:&#x2F;&#x2F;www.titaneric.com&#x2F;posts&#x2F;grafana-loki-upgrade-1&#x2F;&quot;&gt;previous Loki article&lt;&#x2F;a&gt;, we discussed using canary deployments with Vector to replicate real-world logs to a new Loki version. During this process, we tuned the Loki configuration for optimal performance. Once satisfied with the results, we rolled it out to the team.&lt;&#x2F;p&gt;
&lt;p&gt;Our Loki deployment uses a distributed mode, involving multiple components with distinct functions. This makes the Loki architecture complex. Before adjusting specific configurations, it&#x27;s crucial to understand the relationships between these components to make informed decisions.&lt;&#x2F;p&gt;
&lt;p&gt;When tuning Loki, start with the &lt;strong&gt;write&lt;&#x2F;strong&gt;-related components, such as the ingester and distributor, and even the log collector mentioned in the previous article. The goal is to &lt;strong&gt;maximize &quot;Full&quot; Flush Reasons for written chunks, minimizing chunk fragmentation.&lt;&#x2F;strong&gt; This not only improves storage efficiency but also indirectly enhances query speed.&lt;&#x2F;p&gt;
&lt;p&gt;Full chunks mean fewer chunks are needed to represent the same volume of logs. This reduces the number of indexes Loki needs to create. When querying, Loki searches the index based on the query content. Fewer chunks associated with an index result in faster chunk retrieval, allowing the querier to focus on execution and reducing overall query time.&lt;&#x2F;p&gt;
&lt;p&gt;Therefore, we invested significant time in optimizing Loki&#x27;s write performance, which in turn improved read performance. The following sections detail the configuration adjustments we made for both write and read operations.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;loki-write-config-tuning&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loki-write-config-tuning&quot; aria-label=&quot;Anchor link for: loki-write-config-tuning&quot;&gt;Loki Write Config Tuning&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;ingester&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ingester&quot; aria-label=&quot;Anchor link for: ingester&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#ingester&quot;&gt;Ingester&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;ingester.chunk-encoding&lt;&#x2F;code&gt;: Set this directly to &lt;code&gt;snappy&lt;&#x2F;code&gt;. While not the highest compression ratio compared to &lt;code&gt;gzip&lt;&#x2F;code&gt;, it offers a good balance of speed and compression. The &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;bp-configure&#x2F;#use-snappy-compression-algorithm&quot;&gt;official configuration&lt;&#x2F;a&gt; and &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;28&#x2F;the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance&#x2F;&quot;&gt;official blog&lt;&#x2F;a&gt; also recommend using it.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;shard-streams.enabled&lt;&#x2F;code&gt;: After adjusting Loki labels, the number of streams may decrease, but the log volume per stream may increase, potentially exceeding the &lt;code&gt;ingester.per-stream-rate-limit&lt;&#x2F;code&gt;. Enabling this parameter splits streams exceeding &lt;code&gt;shard-streams.desired-rate&lt;&#x2F;code&gt; into multiple stream shards. The distributor automatically adds the &lt;code&gt;__stream_shard__&lt;&#x2F;code&gt; label to these shards, effectively creating distinct streams that the ingester can handle.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.per-stream-rate-limit&lt;&#x2F;code&gt;: If rate limiting persists even with &lt;code&gt;shard-streams.enabled&lt;&#x2F;code&gt;, increase this value, provided the ingester has sufficient resources.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.ingestion-rate-limit-mb&lt;&#x2F;code&gt;: Use the PromQL syntax from the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;grafana&#x2F;loki&#x2F;blob&#x2F;main&#x2F;production&#x2F;loki-mixin-compiled&#x2F;dashboards&#x2F;loki-operational.json&quot;&gt;Loki Operational Dashboard&lt;&#x2F;a&gt; (MBs Per Tenant Panel) to sum the log volume for each tenant and calculate a reasonable global rate limit. Update &lt;code&gt;distributor.ingestion-burst-size-mb&lt;&#x2F;code&gt; accordingly.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;9d552b04f6b44e3c87479a629f9cef4d.png?updatedAt=1750326304000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.max-chunk-age&lt;&#x2F;code&gt;: Although the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2021&#x2F;02&#x2F;16&#x2F;the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki&#x2F;&quot;&gt;official blog&lt;&#x2F;a&gt; suggests setting this to &lt;code&gt;2h&lt;&#x2F;code&gt;, we increased it to &lt;code&gt;4h&lt;&#x2F;code&gt; after adjusting Loki labels as described in the previous article. We also adjusted &lt;code&gt;ingester.chunks-idle-period&lt;&#x2F;code&gt; to &lt;code&gt;4h&lt;&#x2F;code&gt;. This extra time allows logs from one-off tasks or scheduled jobs to be written to the same chunk, increasing the likelihood of a &quot;full&quot; Chunk Flush Reason instead of &quot;max age&quot;. Another benefit, as mentioned in &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2024&#x2F;01&#x2F;04&#x2F;the-concise-guide-to-loki-how-to-work-with-out-of-order-and-older-logs&#x2F;&quot;&gt;official blog&lt;&#x2F;a&gt;, is that we can tolerate older out-of-order ingestion. This is helpful if there are misconfigurations in Vector, mistakenly sending error-handling logs to Loki. The extra time allows us to troubleshoot and resolve the issue, preventing Loki from rejecting logs due to out-of-order ingestion. While increasing this parameter slightly increases ingester memory usage, it&#x27;s less than the memory saved by adjusting Loki labels, making it an acceptable trade-off.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;ingester.readiness-check-ring-health&lt;&#x2F;code&gt;: With multiple ingester replicas, restarting the ingester statefulset defaults to checking the health of the ingester ring, which can take up to 10 minutes per ingester. Consider setting this to &lt;code&gt;false&lt;&#x2F;code&gt; to only check the health of the ingester itself, reducing the waiting time to &lt;strong&gt;2 minutes&lt;&#x2F;strong&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.zone-awareness-enabled&lt;&#x2F;code&gt;: This parameter is well-encapsulated in the &lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart&#x27;s &lt;code&gt;ingester.zoneAwareReplication&lt;&#x2F;code&gt;. As shown below, specifying the number of ingester replicas and affinity allows you to deploy different ingesters &lt;strong&gt;evenly&lt;&#x2F;strong&gt; across different AZs, achieving higher write availability.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;ingester&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;replicas&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;12
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneAwareReplication&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneA&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;extraAffinity&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;nodeAffinity&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;nodeSelectorTerms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;matchExpressions&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;nodepool
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;operator&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;In
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;values&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;            - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;availability-zone
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;operator&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;In
&lt;&#x2F;span&gt;&lt;span&gt;              &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;values&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;              - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;az-1
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneB&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;zoneC&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;distributor&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#distributor&quot; aria-label=&quot;Anchor link for: distributor&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#distributor&quot;&gt;Distributor&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;distributor.client-cleanup-period&lt;&#x2F;code&gt;: In the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;get-started&#x2F;components&#x2F;#rate-limiting&quot;&gt;Loki architecture&lt;&#x2F;a&gt;, the distributor periodically requests the log volume of each stream from the ingester as a rate limit reference. Additionally, the distributor updates clients every &lt;code&gt;distributor.client-cleanup-period&lt;&#x2F;code&gt;, removing non-existent ingester connections. During ingester restarts, if the distributor doesn&#x27;t update connections promptly, it may mistakenly send logs to non-existent ingesters. Consider reducing this period to remove unhealthy connections faster and prevent errors.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;distributor.rate-store.ingester-request-timeout&lt;&#x2F;code&gt;: If network instability causes long request times from the distributor to the ingester, resulting in timeouts, slightly increase this value to prevent distributor errors.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;loki-read-config-tuning&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loki-read-config-tuning&quot; aria-label=&quot;Anchor link for: loki-read-config-tuning&quot;&gt;Loki Read Config Tuning&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;querier&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#querier&quot; aria-label=&quot;Anchor link for: querier&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#querier&quot;&gt;Querier&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Refer to the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;28&#x2F;the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance&#x2F;&quot;&gt;official blog&lt;&#x2F;a&gt; for detailed information on Loki querier tuning. The author uses excellent animations to illustrate how querier-related parameters affect query behavior and provides various metrics to help Loki administrators identify current issues.&lt;&#x2F;p&gt;
&lt;p&gt;The following LogQL syntax (adjusted for our use case) was particularly helpful for tuning:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#fafafa;color:#61676c;&quot;&gt;&lt;code&gt;&lt;span&gt;{component=&amp;quot;querier&amp;quot;, cluster=&amp;quot;$cluster&amp;quot;, namespace=&amp;quot;$namespace&amp;quot;} 
&lt;&#x2F;span&gt;&lt;span&gt;  |= &amp;quot;metrics.go&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  | logfmt
&lt;&#x2F;span&gt;&lt;span&gt;  | latency=&amp;quot;slow&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  | query_type=&amp;quot;metric&amp;quot; or query_type=&amp;quot;filter&amp;quot; or query_type=&amp;quot;limited&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format 
&lt;&#x2F;span&gt;&lt;span&gt;      duration_s=`{{.duration | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      queue_time_s=`{{.queue_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunk_refs_s=`{{.chunk_refs_fetch_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunk_total_s=`{{.store_chunks_download_time | duration}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      cache_download_chunk_s=`{{.cache_chunk_download_time | duration}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format total_time_s=`{{addf .queue_time_s .duration_s}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | label_format        
&lt;&#x2F;span&gt;&lt;span&gt;      queue_pct=`{{mulf (divf .queue_time_s .total_time_s) 100 }}`,
&lt;&#x2F;span&gt;&lt;span&gt;      index_pct=`{{mulf (divf (.chunk_refs_fetch_time | duration) .total_time_s) 100 }}`,
&lt;&#x2F;span&gt;&lt;span&gt;      chunks_pct=`{{mulf (divf .chunk_total_s .total_time_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      execution_pct=`{{mulf (divf (subf .duration_s .chunk_refs_s .chunk_total_s) .total_time_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      cache_download_pct=`{{mulf (divf .cache_download_chunk_s .chunk_total_s) 100}}`,
&lt;&#x2F;span&gt;&lt;span&gt;      avg_chunk_size=`{{divf (divf (bytes .total_bytes) .cache_chunk_req 1000)}}`
&lt;&#x2F;span&gt;&lt;span&gt;  | line_format `| total_time {{printf &amp;quot;%3.0f&amp;quot; (.total_time_s | float64)}}s | queued {{printf &amp;quot;%3.0f&amp;quot; (.queue_pct | float64)}}% | execution {{printf &amp;quot;%3.0f&amp;quot; (.execution_pct | float64)}}% | index {{printf &amp;quot;%3.0f&amp;quot; (.index_pct | float64)}}% | store {{printf &amp;quot;%3.0f&amp;quot; (.chunks_pct | float64)}}% (cache {{ printf &amp;quot;%3.0f&amp;quot; (.cache_download_pct | float64) }}%) | avg_chunk {{printf &amp;quot;%3.0f&amp;quot; (.avg_chunk_size | float64)}}kB | {{ .query }}`
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This displays the time spent in four different phases when the querier executes a slow query (execution time greater than 10 seconds) during subquery execution:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;queued&lt;&#x2F;strong&gt;: Time spent waiting in the queue.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;index&lt;&#x2F;strong&gt;: Time spent searching the index based on Loki labels.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;store&lt;&#x2F;strong&gt;: Time spent retrieving chunks from cache or object storage after obtaining the index.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;execution&lt;&#x2F;strong&gt;: Time spent executing the query in the querier after retrieving the chunks.&lt;&#x2F;p&gt;
&lt;p&gt;Aim for the highest possible &lt;strong&gt;execution&lt;&#x2F;strong&gt; ratio (over 80%), indicating that the querier is spending CPU time calculating results rather than waiting for I&#x2F;O. The blog provides guidance on adjusting configurations if query time is spent in other phases.&lt;&#x2F;p&gt;
&lt;p&gt;We&#x27;ve also customized the &lt;strong&gt;store&lt;&#x2F;strong&gt; presentation by adding a &lt;strong&gt;cache&lt;&#x2F;strong&gt; metric, representing the time the querier spends retrieving chunks from the cache. This ratio should be as close to 100% as possible, indicating that chunk retrieval primarily occurs from the faster cache rather than the much slower object storage. This helped us identify that our previous chunk cache was inefficient and required further tuning, which will be discussed later.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;chunk-cache&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#chunk-cache&quot; aria-label=&quot;Anchor link for: chunk-cache&quot;&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#chunk_store_config&quot;&gt;Chunk Cache&lt;&#x2F;a&gt;&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;If you&#x27;ve read &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;08&#x2F;23&#x2F;how-we-scaled-grafana-cloud-logs-memcached-cluster-to-50tb-and-improved-reliability&#x2F;&quot;&gt;this official blog post&lt;&#x2F;a&gt;, you might consider replacing Loki&#x27;s chunk cache with Memcached and using &lt;code&gt;extstore&lt;&#x2F;code&gt; to mount fast SSDs. This provides more space and cost-effectively improves Loki query performance. We also attempted to calculate the hot query intervals using LogQL, as described in the article. While the article doesn&#x27;t provide the exact query syntax, we used the following LogQL with a heatmap:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#fafafa;color:#61676c;&quot;&gt;&lt;code&gt;&lt;span&gt;sum_over_time({cluster=&amp;quot;$cluster&amp;quot;, namespace=&amp;quot;$namespace&amp;quot;, app=&amp;quot;loki&amp;quot;, component=&amp;quot;query-frontend&amp;quot;} |= &amp;quot;metrics.go&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  |= &amp;quot;query_type&amp;quot; | logfmt | query_type=&amp;quot;metric&amp;quot; or query_type=&amp;quot;filter&amp;quot; or query_type=&amp;quot;limited&amp;quot; 
&lt;&#x2F;span&gt;&lt;span&gt;  | unwrap duration(start_delta)[5m])
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The heatmap below shows that most query intervals fall within the past 9 hours. After discussion, we decided that the cache should retain at least one day&#x27;s worth of chunks and calculated the required cache space accordingly.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;8df2bccc2f424c3e9be76978042895e2.png?updatedAt=1750326446000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Our old Loki used Redis as a chunk cache. The current &lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart has excellent support for Memcached, so we decided to apply these settings to the new Loki. However, the results were not as expected.&lt;&#x2F;p&gt;
&lt;p&gt;Using the LogQL syntax mentioned earlier, we found that the querier spent over 30% of its time in the &lt;strong&gt;store&lt;&#x2F;strong&gt; phase, and the &lt;strong&gt;cache&lt;&#x2F;strong&gt; phase ratio was less than 50%. This meant we were spending time waiting for chunk downloads from both the cache and object storage, which contradicted our expectation of a near 100% &lt;strong&gt;cache&lt;&#x2F;strong&gt; phase ratio and minimal &lt;strong&gt;store&lt;&#x2F;strong&gt; phase ratio.&lt;&#x2F;p&gt;
&lt;p&gt;After &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;community.grafana.com&#x2F;t&#x2F;enabling-loki-jaeger-tracing&#x2F;51483&quot;&gt;enabling Loki&#x27;s Jaeger tracing feature&lt;&#x2F;a&gt;, we discovered that the querier spent over 10 seconds retrieving chunks from the cache. Combined with the &lt;strong&gt;execution&lt;&#x2F;strong&gt; phase time, we frequently encountered timeout issues.&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately, we found a solution on the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;memcached&#x2F;memcached&#x2F;wiki&#x2F;ConfiguringLokiExtstore&quot;&gt;official memcached GitHub&lt;&#x2F;a&gt;. The following are the official recommended Memcached settings:&lt;&#x2F;p&gt;
&lt;p&gt;Keep &lt;code&gt;ingester.chunk-target-size&lt;&#x2F;code&gt; and the maximum item size in Memcached (&lt;code&gt;-I&lt;&#x2F;code&gt; parameter) relatively small (e.g., &lt;code&gt;2MB&lt;&#x2F;code&gt;). Also, add the special extstore parameters to Memcached.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;memcached&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -m&lt;&#x2F;span&gt;&lt;span&gt; 6000&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -I&lt;&#x2F;span&gt;&lt;span&gt; 2m &lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;\
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;	-o&lt;&#x2F;span&gt;&lt;span&gt; ext_path=&#x2F;disk&#x2F;extstore:500G,ext_wbuf_size=32,ext_threads=10,ext_max_sleep=10000,slab_automove_freeratio=0.10,ext_recache_rate=0
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In the Loki configuration, set small batch sizes and parallelism, and increase the timeout.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.batchsize&lt;&#x2F;code&gt; determines how many Memcached keys the Memcached client retrieves at once. Set this to twice the number of Memcached servers.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.parallelism&lt;&#x2F;code&gt; determines how many Go routines simultaneously retrieve Memcached keys. Set this to the lowest possible value, but increase it if network bandwidth allows.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;store.chunks-cache.memcached.timeout&lt;&#x2F;code&gt; includes the time for Memcached to retrieve the cache and the serialization time. Large chunk item sizes or batch sizes can affect the timeout. The default is &lt;code&gt;100ms&lt;&#x2F;code&gt;, but it&#x27;s strongly recommended to increase it to a higher value, such as &lt;code&gt;60s&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;blockquote&gt;
&lt;p&gt;Loki&#x27;s memcache client timeout is measuring the amount of time to &lt;em&gt;fetch and read and process the entire batch of keys from each host&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;&#x2F;blockquote&gt;
&lt;p&gt;&lt;code&gt;store.background.write-back-concurrency&lt;&#x2F;code&gt; represents the number of Go routines writing to Memcached. Set this to 1 to avoid aggressively writing to Memcached, which can cause some items to be evicted.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yml &quot;&gt;&lt;code class=&quot;language-yml&quot; data-lang=&quot;yml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;chunk_store_config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;chunk_cache_config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;memcached&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;batch_size&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;3
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;parallelism&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;2
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;memcached_client&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;addresses&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;127.0.0.1:11211
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;timeout&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;60s
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;background&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_goroutines&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_buffer&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;1000
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;writeback_size_limit&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;500MB
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;results&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#results&quot; aria-label=&quot;Anchor link for: results&quot;&gt;Results&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;write-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#write-performance&quot; aria-label=&quot;Anchor link for: write-performance&quot;&gt;Write Performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;The graph below shows that Loki no longer discards incoming logs due to rate limiting at the distributor end. This is because the ingester has sufficient write performance, combined with appropriate distributor rate limit and shard-streams adjustments.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;9b3cf57812b44d2dab95e0dc953a2047.png?updatedAt=1750326529000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h3 id=&quot;query-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#query-performance&quot; aria-label=&quot;Anchor link for: query-performance&quot;&gt;Query Performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;The following is the execution result of the modified official LogQL mentioned earlier. Even for slow subqueries, the &lt;strong&gt;execution&lt;&#x2F;strong&gt; phase accounts for over 90% of the execution time, and the &lt;strong&gt;cache&lt;&#x2F;strong&gt; portion accounts for over 95%. This confirms that chunks are primarily retrieved from the cache, saving time for calculating the final LogQL results.&lt;&#x2F;p&gt;
&lt;p&gt;There&#x27;s still room for improvement in the &lt;strong&gt;execution&lt;&#x2F;strong&gt; phase, potentially by increasing the number of querier replicas, increasing CPU resources, or improving LogQL syntax to further accelerate search times.
&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;0bd7beb9a0124ea0bda1d474e06d1577.png?updatedAt=1750326541000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;The graph below shows the query time over time. The yellow line represents the 99th percentile, and the orange line represents the 90th percentile. Most query times are less than 10 seconds.
&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;2596fdc70a26474ab054f0f1e2713906.png?updatedAt=1750326553000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h3 id=&quot;cache-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cache-performance&quot; aria-label=&quot;Anchor link for: cache-performance&quot;&gt;Cache Performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;The chunk cache hit rate remains above 70% most of the time. This prevents Loki from retrieving chunks from the much slower Object Storage and reduces the load on Object Storage.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;5b6c5c0beb504dceb2a4d8e3de6fe7af.png?updatedAt=1750326563000&quot; alt=&quot;&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;In this article, we focused on Loki configuration tuning. We explained why write performance should be prioritized, as it affects read performance. We then covered the detailed configuration settings for the components responsible for writing and reading in Loki. We especially thank Grafana and Memcached for providing technical articles that guided our adjustments.&lt;&#x2F;p&gt;
&lt;p&gt;The final result is that we can receive logs from the log collector as much as possible during writing, and we can fully utilize the cache during querying, reducing the load on Object Storage. The results are satisfactory. We will continue to improve the performance of the log collector and Loki to provide Loki users with a better user experience.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Grafana Loki系列文章(I) - 使用金絲雀部署升級Loki：提升效能同時節省成本的實踐經驗</title>
          <pubDate>Fri, 14 Feb 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/grafana-loki-upgrade-1-zh/</link>
          <guid>https://www.titaneric.com/posts/grafana-loki-upgrade-1-zh/</guid>
          <description xml:base="https://www.titaneric.com/posts/grafana-loki-upgrade-1-zh/">&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;7ebbf0334cc14d71818a451b89847db8.png?updatedAt=1739524743000&quot; alt=&quot;&quot; &#x2F;&gt;
&lt;em&gt;&lt;p style=&quot;text-align:center&quot;&gt;Generated by Microsoft Designer&lt;&#x2F;p&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tldr&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#tldr&quot; aria-label=&quot;Anchor link for: tldr&quot;&gt;TLDR&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;在LINE Taiwan，我們決定使用金絲雀部署進行Loki升級&lt;&#x2F;li&gt;
&lt;li&gt;使用Vector取代Promtail協助我們處理log並送往Loki&lt;&#x2F;li&gt;
&lt;li&gt;使用Vector去複製真實流量到新版Loki，幫助我們調整Loki config&lt;&#x2F;li&gt;
&lt;li&gt;使用Vector改善Loki labels，大幅度增進Loki效能&lt;&#x2F;li&gt;
&lt;li&gt;最終省下近70%的機器成本，將後端儲存的負擔降到最低。&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;bei-jing&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#bei-jing&quot; aria-label=&quot;Anchor link for: bei-jing&quot;&gt;背景&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;observability-platform&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#observability-platform&quot; aria-label=&quot;Anchor link for: observability-platform&quot;&gt;Observability Platform&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;LINE Taiwan的observability platform主要使用Grafana提供的生態系，利用Grafana當作dashboard以及搜尋log、metrics以及trace的媒介。在metrics部分，我們使用公司提供相容於Prometheus API的系統，Log部分使用自建的Loki cluster，Trace部分則是使用自建的Tempo cluster。&lt;&#x2F;p&gt;
&lt;p&gt;當時我們的Loki cluster版本是2.8，並使用&lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; helm chart部署，後端儲存使用公司提供的相容於S3 API的Object Storage系統，比較特別的是，我們按照&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#s3_storage_config&quot;&gt;Loki config&lt;&#x2F;a&gt;的說明，設定10個sharding buckets，嘗試分散bucket流量。cache部分則是使用公司提供的Redis Service。因應多的專案及團隊，我們有開啟&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;operations&#x2F;multi-tenancy&#x2F;&quot;&gt;multi-tenant&lt;&#x2F;a&gt;設定。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;lokisheng-ji&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#lokisheng-ji&quot; aria-label=&quot;Anchor link for: lokisheng-ji&quot;&gt;Loki升級&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;在去年底時，SRE計劃將Loki cluster升級到3.3，那時的Loki已經有官方維護的&lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart，並且在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;setup&#x2F;install&#x2F;helm&#x2F;install-scalable&#x2F;#deploying-the-helm-chart-for-development-and-testing&quot;&gt;安裝文件&lt;&#x2F;a&gt;直接使用這個helm chart進行安裝，不再仰賴於靠社群維護的&lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; helm chart。&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;setup&#x2F;migrate&#x2F;migrate-from-distributed&#x2F;&quot;&gt;Loki官方文件&lt;&#x2F;a&gt;也有提到如何從&lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; migrate到&lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart的方法，因此推斷這個舊的helm chart將會被deprecate，另外在稍微看過官方migration流程後，覺得不太方便實施。在綜合因素下，同時部署Loki的observability cluster資源還算充足，最後決定部建第二套新的Loki cluster，直接採用&lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart部署，希望能透過設計出新的架構、流程及config，去解決當時Loki的各項問題。&lt;&#x2F;p&gt;
&lt;p&gt;在設計migration流程時，我們希望能讓這個新版Loki cluster直接承擔production流量，方便在過程中能針對Loki的config做一些tuning，等到性能調校差不多後，就能逐步開放beta以及production使用。所以如何設計一個平滑的搬遷流程是我們的首要目標，這也是本文的著重重點，Loki細項的config調整將會在下一篇提及。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;fang-fa&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#fang-fa&quot; aria-label=&quot;Anchor link for: fang-fa&quot;&gt;方法&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;cong-promtail-qian-yi-dao-vector&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cong-promtail-qian-yi-dao-vector&quot; aria-label=&quot;Anchor link for: cong-promtail-qian-yi-dao-vector&quot;&gt;從 Promtail 遷移到 Vector&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;如前面提到的，我們希望能在migration期間，並存兩套Loki cluster，並且都收同樣的log，這需要在log collector那邊下功夫，我們當時是使用Grafana出的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;promtail&#x2F;&quot;&gt;Promtail&lt;&#x2F;a&gt;，雖然說Promtail可以設定第二個Loki endpoint，不過Promtail config不好維護而且官方也說明Promtail已經不再接受更新，他們改專注在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;alloy&#x2F;&quot;&gt;Alloy&lt;&#x2F;a&gt;的開發。&lt;&#x2F;p&gt;
&lt;p&gt;在衡量該替換成哪個log collector時，我們考量目前的幾點需求：&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;能正常收kubernetes logs，並有基本的k8s metadata資訊&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;允許送log到Loki去&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;能夠將log內容做些基本的處理，例如masking敏感資料或是調整Loki label&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;alloy&#x2F;&quot;&gt;Alloy&lt;&#x2F;a&gt;雖然皆滿足以上需求，我們也曾在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;techblog.lycorp.co.jp&#x2F;zh-hant&#x2F;grafana-alloy-best-practice&quot;&gt;其他場景&lt;&#x2F;a&gt;中使用，不過這時想起主管曾提到&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;&quot;&gt;Vector&lt;&#x2F;a&gt;現正流行，在評估它的功能以後，發現都可以滿足目前需求，也有以下優勢：&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;使用Rust開發，在執行上所需的資源遠小於使用Golang開發的Promtail或是Alloy&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;生態系豐富的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;components&#x2F;&quot;&gt;Vector Components&lt;&#x2F;a&gt;，能依照環境及情境選擇合適的元件&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;提供了稱作&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;&quot;&gt;Vector Remap Language (VRL)&lt;&#x2F;a&gt;的語法，並支持眾多的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;functions&#x2F;&quot;&gt;functions&lt;&#x2F;a&gt;，能根據需求輕易處理log&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;提供了非常方便的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;unit-tests&#x2F;&quot;&gt;Unit Tests&lt;&#x2F;a&gt;功能，能夠驗證你寫的VRL沒有問題&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;我們最後決定將Promtail替換成Vector，流程如下：&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;將現有的Promtail config移植成Vector config：這包含&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;sources&#x2F;kubernetes_logs&#x2F;&quot;&gt;Kubernetes logs source&lt;&#x2F;a&gt;、&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;sinks&#x2F;loki&#x2F;&quot;&gt;Loki sink&lt;&#x2F;a&gt;以及客製化的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;remap&#x2F;&quot;&gt;Remap transform&lt;&#x2F;a&gt;等等元件，也撰寫了多個Unit Tests，這能讓我們有更高的信心，確保Vector config能正常運作。&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sources&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;kubernetes_logs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;transforms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;add_metadata&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;remap&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;source&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;      # custom transformation by VRL
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sinks&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;使用Vector取代Promtail：我們替換的過程如下：
&lt;ol&gt;
&lt;li&gt;先同步Vector，這時舊的Loki會短暫地直接承擔兩倍流量(Promtail+Vector)&lt;&#x2F;li&gt;
&lt;li&gt;下掉Promtail避免Loki的rate limit錯誤影響Vector&lt;&#x2F;li&gt;
&lt;li&gt;藉由Vector自己的retry機制，正常送log到Loki去&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;我們觀察到在替換後，不僅Loki運作正常，同時帶來的效益是Vector所需的記憶體使用是原先Promtail的30%以下，驗證了Vector的高效能表現。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;zhu-bu-zeng-jia-sample-logliu-liang&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#zhu-bu-zeng-jia-sample-logliu-liang&quot; aria-label=&quot;Anchor link for: zhu-bu-zeng-jia-sample-logliu-liang&quot;&gt;逐步增加sample log流量&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Vector提供了&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;sample&#x2F;&quot;&gt;Sample transform&lt;&#x2F;a&gt;功能，可以設定sample rate，進而針對收進來的log進行抽樣，一般應該是用在log量超級大的情境，設定少量但足夠進行排障的sample rate，減少log系統以及後端儲存的負擔。不過我們決定活用這個功能，幫助我們順利地進行Loki migration，具體流程如下。&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;定義&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;sample&#x2F;&quot;&gt;Sample transform&lt;&#x2F;a&gt;，輸入剛使用VRL轉換後的&lt;code&gt;add_metadata&lt;&#x2F;code&gt;元件。以下範例是採用10%(1&#x2F;10)的sample rate。&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;transforms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;add_metadata&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;remap&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;source&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;      # custom transformation by VRL
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sample_log&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;sample
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;rate&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;10
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;定義新的Loki sink，&lt;code&gt;endpoint&lt;&#x2F;code&gt;改成新的Loki，輸入改成剛才的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;sample&#x2F;&quot;&gt;Sample transform&lt;&#x2F;a&gt;元件名稱。以下範例的&lt;code&gt;loki-v3&lt;&#x2F;code&gt;即為新的Loki sink，注意他的輸入是&lt;code&gt;sample_log&lt;&#x2F;code&gt;而不是&lt;code&gt;add_metadata&lt;&#x2F;code&gt;。&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sinks&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki-v3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;sample_log &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_V3_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;
&lt;p&gt;同步Vector config到cluster上，確認新的Loki已經有接收少量，但來自真實環境的log。這時就可以專注在Loki的tuning。&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;隨著Loki的tuning，可以逐步將sample rate拉高，我們一路從10%、33%、50%調整到最終的100%，證明新版Loki可以強健地承擔production環境上的log流量。&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h3 id=&quot;gai-shan-loki-labels&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#gai-shan-loki-labels&quot; aria-label=&quot;Anchor link for: gai-shan-loki-labels&quot;&gt;改善Loki labels&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;我們在log collector還在使用Promtail時，訂了以下的label&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;cluster：k8s cluster名稱&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;namespace： k8s namespace&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;container：定義在&lt;code&gt;spec.containers.name&lt;&#x2F;code&gt;的pod container名稱&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;app：&lt;code&gt;app.kubernetes.io&#x2F;name&lt;&#x2F;code&gt;、&lt;code&gt;app&lt;&#x2F;code&gt; pod labels，或是pod名稱&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;component：&lt;code&gt;app.kubernetes.io&#x2F;component&lt;&#x2F;code&gt;或&lt;code&gt;component&lt;&#x2F;code&gt; pod labels&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;instance：&lt;code&gt;app.kubernetes.io&#x2F;instance&lt;&#x2F;code&gt;或&lt;code&gt;instance&lt;&#x2F;code&gt; pod labels&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;nodename：當時pod部署的node名稱&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;pod：pod名稱&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;stream：log是&lt;code&gt;stderr&lt;&#x2F;code&gt;或&lt;code&gt;stdout&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;在詳細閱讀&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;20&#x2F;the-concise-guide-to-grafana-loki-everything-you-need-to-know-about-labels&#x2F;&quot;&gt;The concise guide to Grafana Loki: Everything you need to know about labels&lt;&#x2F;a&gt;這篇官方blog後，深深體悟到目前的label設計對Loki儲存以及搜尋上是非常沒有效率的，因此我們決定針對label進行大幅度的改善。&lt;&#x2F;p&gt;
&lt;p&gt;我們決定移除&lt;code&gt;pod&lt;&#x2F;code&gt;以及&lt;code&gt;nodename&lt;&#x2F;code&gt;這些high cardinality的label，改放在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;get-started&#x2F;labels&#x2F;structured-metadata&#x2F;?pg=blog&amp;amp;plcmt=body-txt&quot;&gt;structured metadata&lt;&#x2F;a&gt;，雖然他的檢索速度不及label，但是這更符合官方建議，而且也能透過引進&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;operations&#x2F;bloom-filters&#x2F;&quot;&gt;Bloom Filters&lt;&#x2F;a&gt;，帶來潛在的搜尋加速。我們也另外放入對搜尋log有幫助的&lt;code&gt;availability_zone&lt;&#x2F;code&gt;, &lt;code&gt;nodepool&lt;&#x2F;code&gt;以及&lt;code&gt;trace_id&lt;&#x2F;code&gt;。&lt;&#x2F;p&gt;
&lt;p&gt;我們還針對&lt;code&gt;app&lt;&#x2F;code&gt;這個label做特別處理，除了前述app相關的pod label之外，如果pod有parent resource，例如他是daemonset、statefulset或是deployment，我們會將pod owner的欄位取出，處理後寫入到&lt;code&gt;app&lt;&#x2F;code&gt; label中。&lt;&#x2F;p&gt;
&lt;p&gt;我們也另外針對k8s client library或是controller生成的pod做處理。因為它們通常會是一次性任務的job，或是沒有parent resource但是suffix複雜的pod名稱，這樣就不能用前面的方式處理，這時必須更積極地看目前還有哪些&lt;code&gt;app&lt;&#x2F;code&gt; label沒有被處理，這時可以使用下方的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;query&#x2F;logcli&#x2F;logcli-tutorial&#x2F;#checking-series-cardinality&quot;&gt;logcli&lt;&#x2F;a&gt;指令協助看不同的Loki tenant的stream有哪些，針對常見而且量大的stream中的label作處理。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span&gt;LOKI_ADDR&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt;loki-gateway&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span&gt;LOKI_ORG_ID&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt;tenant-id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;logcli&lt;&#x2F;span&gt;&lt;span&gt; series &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;#39;{}&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;這些操作完成之後，預期在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;grafana&#x2F;loki&#x2F;blob&#x2F;main&#x2F;production&#x2F;loki-mixin-compiled&#x2F;dashboards&#x2F;loki-operational.json&quot;&gt;Loki Operational Dashboard&lt;&#x2F;a&gt;將會看到兩個顯著的變化。&lt;&#x2F;p&gt;
&lt;h4 id=&quot;streams&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#streams&quot; aria-label=&quot;Anchor link for: streams&quot;&gt;Streams&lt;&#x2F;a&gt;&lt;&#x2F;h4&gt;
&lt;p&gt;由以下結果可以看出，stream的寫入數量從最高的20K，大幅減少至3K。stream數量的改變將會改善chunk的使用率，在之後會說明。&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;993ccf977b9b4e8ca123c7400113cc0f.png?updatedAt=1739524948000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;c0aab6613b19447ba19aae6ee8d395c5.png?updatedAt=1739524958000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h4 id=&quot;chunk-flush-reason&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#chunk-flush-reason&quot; aria-label=&quot;Anchor link for: chunk-flush-reason&quot;&gt;Chunk Flush Reason&lt;&#x2F;a&gt;&lt;&#x2F;h4&gt;
&lt;p&gt;從下圖可以看出，&lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason從原先的70%增加到90%以上。理論上總體log量不會變，但因為stream數量變少，使得每一條stream需要消化的log量將會增大，這將會加速該條stream的chunk寫入，使得chunk更快被填滿，最終導致&lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason比率的增加。&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;2e73cc7626fd41259a3cc4e6edba98ba.png?updatedAt=1739524974000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;61d1990e3bb3496f9b1dcbff3cf59b1e.png?updatedAt=1739524983000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h2 id=&quot;cheng-xiao&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cheng-xiao&quot; aria-label=&quot;Anchor link for: cheng-xiao&quot;&gt;成效&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;除了前面提到的&lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason比率提高以及Stream數量的減少之外，針對Loki labels的改善還帶來以下好處。&lt;&#x2F;p&gt;
&lt;h3 id=&quot;geng-gao-de-ingesterxie-ru-xiao-neng&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#geng-gao-de-ingesterxie-ru-xiao-neng&quot; aria-label=&quot;Anchor link for: geng-gao-de-ingesterxie-ru-xiao-neng&quot;&gt;更高的Ingester寫入效能&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;在改善Loki labels的前後，所需的Ingester資源差異列在下表，可以看到Ingester需要的replica減少到原先的30%左右，需要的memory更減少到25%以下。在worker node部分因為我們有特別為Ingester設定pod anti-affinity，所以node數量會跟ingester一樣，每個月省下的成本估計為7萬日幣。&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;&#x2F;th&gt;&lt;th&gt;Ingester&#x27;s #replicas&lt;&#x2F;th&gt;&lt;th&gt;CPU core&lt;&#x2F;th&gt;&lt;th&gt;memory usage in GB&lt;&#x2F;th&gt;&lt;th&gt;dedicated worker node&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;Before&lt;&#x2F;td&gt;&lt;td&gt;30&lt;&#x2F;td&gt;&lt;td&gt;10&lt;&#x2F;td&gt;&lt;td&gt;90&lt;&#x2F;td&gt;&lt;td&gt;30&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;After&lt;&#x2F;td&gt;&lt;td&gt;12&lt;&#x2F;td&gt;&lt;td&gt;7.5&lt;&#x2F;td&gt;&lt;td&gt;21&lt;&#x2F;td&gt;&lt;td&gt;12&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h3 id=&quot;wan-quan-xiao-chu-object-storagefa-sheng-rate-limitji-hui&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#wan-quan-xiao-chu-object-storagefa-sheng-rate-limitji-hui&quot; aria-label=&quot;Anchor link for: wan-quan-xiao-chu-object-storagefa-sheng-rate-limitji-hui&quot;&gt;完全消除Object Storage發生rate limit機會&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;另一個改善Loki labels帶來的效益是，過去在Object Storage頻繁發生的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;line-objects-internal.com&#x2F;notes-line-dev-files&#x2F;uploads&#x2F;02032190-a1f1-473e-9042-a2db60066052.png&quot;&gt;rate limit錯誤（429）&lt;&#x2F;a&gt;已經不再出現。以下的圖表顯示4xx HTTP status code錯誤的前後差異，能看出在新版Loki所使用的bucket沒有任何錯誤發生。我們判斷是因為新版Loki的&lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason高達九成，再加上Compactor幫忙壓縮剩餘沒有滿的chunk，造成幾乎所有的chunk都是資料密集。比起過去需要使用多個稀疏的chunk，現在可以用更少數量的密集chunk就可以存放相同的log量。這使得Loki在查詢時，需要的Object Storage API請求次數也跟著變少，也就導致rate limit不再發生。另外，我們推斷sharding buckets數量從10增加到20也有幫助。&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;5ba2e53b5b8d4963944d25be4c7cca9b.png?updatedAt=1739525018000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;24f2bcbf7e2c4fc588ad7342dbb39ece.png?updatedAt=1739525034000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h2 id=&quot;jie-lun&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#jie-lun&quot; aria-label=&quot;Anchor link for: jie-lun&quot;&gt;結論&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;在本文中，介紹了我們如何平滑地migrate Loki cluster，特別是使用Vector去取代Promtail，大量地運用Vector提供的功能強大&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;&quot;&gt;Vector Remap Language&lt;&#x2F;a&gt;以及生態系豐富的&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;components&#x2F;&quot;&gt;Vector Components&lt;&#x2F;a&gt;，幫助我們在migrate過程中，除了能不影響現有使用者的操作，更能透過sample技巧，讓新版Loki能接收來自production環境的log。&lt;&#x2F;p&gt;
&lt;p&gt;在有了實際的log流量之後，我們也才能針對新版Loki的config進行重點調校。我們還按照官方建議，針對Loki labels進行特別處理，大幅提升Loki寫入效能，以及完全消弭查詢log帶來的潛在Object Storage負擔。&lt;&#x2F;p&gt;
&lt;p&gt;此外，Vector也提供了&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;log_to_metric&#x2F;&quot;&gt;Log to Metric Transform&lt;&#x2F;a&gt;功能，能夠將log中紀錄的數值直接轉換成Prometheus metrics，我們使用這功能改進&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;techblog.lycorp.co.jp&#x2F;zh-hant&#x2F;grafana-alloy-best-practice&quot;&gt;先前Alloy使用經驗&lt;&#x2F;a&gt;，取代掉Loki Ruler進而降低Loki負擔。值得一題的是我在使用Vector上碰到一些可以改進的地方，我也嘗試做些&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;vectordotdev&#x2F;vector&#x2F;pulls?q=is%3Apr+is%3Amerged+author%3Atitaneric&quot;&gt;Vector貢獻&lt;&#x2F;a&gt;，希望Vector能發展的更好。&lt;&#x2F;p&gt;
&lt;p&gt;最後，在前面提及的Loki labels改善，事實上會對Loki的Distributor造成潛在負擔，還有其他的Loki component需要做些特別的tuning，更多的Loki config調整細節，將會在下一篇文章中提到，敬請期待！&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Grafana Loki Series (I) - Upgrading Loki with a Canary Deployment: Enhancing Performance and Reducing Costs</title>
          <pubDate>Fri, 14 Feb 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/grafana-loki-upgrade-1/</link>
          <guid>https://www.titaneric.com/posts/grafana-loki-upgrade-1/</guid>
          <description xml:base="https://www.titaneric.com/posts/grafana-loki-upgrade-1/">&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;7ebbf0334cc14d71818a451b89847db8.png?updatedAt=1739524743000&quot; alt=&quot;&quot; &#x2F;&gt;
&lt;em&gt;&lt;p style=&quot;text-align:center&quot;&gt;Generated by Microsoft Designer&lt;&#x2F;p&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tldr&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#tldr&quot; aria-label=&quot;Anchor link for: tldr&quot;&gt;TLDR&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;At LINE Taiwan, we decided to upgrade Loki using a canary deployment strategy.&lt;&#x2F;li&gt;
&lt;li&gt;Replaced Promtail with Vector to handle logs and send them to Loki.&lt;&#x2F;li&gt;
&lt;li&gt;Used Vector to replicate real traffic to the new Loki, helping us adjust Loki configurations.&lt;&#x2F;li&gt;
&lt;li&gt;Improved Loki labels with Vector, significantly enhancing Loki&#x27;s performance.&lt;&#x2F;li&gt;
&lt;li&gt;Ultimately saved nearly 70% in machine costs, minimizing backend storage burden.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;background&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#background&quot; aria-label=&quot;Anchor link for: background&quot;&gt;Background&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;observability-platform&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#observability-platform&quot; aria-label=&quot;Anchor link for: observability-platform&quot;&gt;Observability Platform&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;LINE Taiwan&#x27;s observability platform primarily uses the Grafana ecosystem, utilizing Grafana as a dashboard and a medium for searching logs, metrics, and traces. For metrics, we use a Prometheus API-compatible system provided by the company. For logs, we use a self-built Loki cluster, and for traces, we use a self-built Tempo cluster.&lt;&#x2F;p&gt;
&lt;p&gt;At that time, our Loki cluster version was 2.8, deployed using the &lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; helm chart, with backend storage using an S3 API-compatible Object Storage system provided by the company. Notably, we set up 10 sharding buckets according to the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;configure&#x2F;#s3_storage_config&quot;&gt;Loki config&lt;&#x2F;a&gt; to distribute bucket traffic. The Loki&#x27;s cache used the company&#x27;s Redis Service. Due to the numerous projects and teams, we enabled the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;operations&#x2F;multi-tenancy&#x2F;&quot;&gt;multi-tenant&lt;&#x2F;a&gt; setting.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;loki-upgrade&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#loki-upgrade&quot; aria-label=&quot;Anchor link for: loki-upgrade&quot;&gt;Loki Upgrade&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;At the end of last year, the SRE team planned to upgrade the Loki cluster to version 3.3. By then, Loki had an officially maintained &lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart, and the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;setup&#x2F;install&#x2F;helm&#x2F;install-scalable&#x2F;#deploying-the-helm-chart-for-development-and-testing&quot;&gt;installation documentation&lt;&#x2F;a&gt; directly used this helm chart for installation, no longer relying on the community-maintained &lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; helm chart. The &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;setup&#x2F;migrate&#x2F;migrate-from-distributed&#x2F;&quot;&gt;official Loki documentation&lt;&#x2F;a&gt; also mentioned how to migrate from the &lt;code&gt;grafana&#x2F;loki-distributed&lt;&#x2F;code&gt; helm chart to the &lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart, suggesting that the old helm chart would be deprecated. After reviewing the official migration process, we found it inconvenient to implement. Considering various factors and the sufficient resources of the observability cluster, we decided to build a second new Loki cluster using the &lt;code&gt;grafana&#x2F;loki&lt;&#x2F;code&gt; helm chart, hoping to solve the existing Loki issues through new architecture, processes, and configurations.&lt;&#x2F;p&gt;
&lt;p&gt;When designing the migration process, we aimed to let the new Loki cluster handle production traffic directly and tune Loki&#x27;s configuration during the process. Once the performance tuning was satisfactory, we could gradually announce it for beta and production use. Therefore, designing a smooth migration process was our primary goal, which is the focus of this article. Detailed Loki configuration adjustments will be discussed in the next article.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;method&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#method&quot; aria-label=&quot;Anchor link for: method&quot;&gt;Method&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;migrating-from-promtail-to-vector&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#migrating-from-promtail-to-vector&quot; aria-label=&quot;Anchor link for: migrating-from-promtail-to-vector&quot;&gt;Migrating from Promtail to Vector&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;As mentioned earlier, we wanted to run two Loki clusters concurrently during the migration, both receiving the same logs, which required effort on the log collector side. At that time, we used Grafana&#x27;s &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;promtail&#x2F;&quot;&gt;Promtail&lt;&#x2F;a&gt;. Although Promtail could set a second Loki endpoint, its configuration was hard to maintain, and the official documentation stated that Promtail was no longer accepting updates, focusing instead on the development of &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;alloy&#x2F;&quot;&gt;Alloy&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;When considering which log collector to replace, we evaluated the following needs:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Properly collect Kubernetes logs with basic k8s metadata.&lt;&#x2F;li&gt;
&lt;li&gt;Allow sending logs to Loki.&lt;&#x2F;li&gt;
&lt;li&gt;Perform basic log processing, such as masking sensitive data or adjusting Loki labels.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Although &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;send-data&#x2F;alloy&#x2F;&quot;&gt;Alloy&lt;&#x2F;a&gt; met these requirements and we had used it in &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;techblog.lycorp.co.jp&#x2F;zh-hant&#x2F;grafana-alloy-best-practice&quot;&gt;other scenarios&lt;&#x2F;a&gt;, we recalled that our lead mentioned &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;&quot;&gt;Vector&lt;&#x2F;a&gt; was popular. After evaluating its features, we found it not only met our current needs, but also had the following advantages:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Developed in Rust, requiring fewer resources to run compared to Promtail or Alloy developed in Golang.&lt;&#x2F;li&gt;
&lt;li&gt;Rich ecosystem of &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;components&#x2F;&quot;&gt;Vector Components&lt;&#x2F;a&gt;, allowing us to choose suitable components based on the environment and scenario.&lt;&#x2F;li&gt;
&lt;li&gt;Provided the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;&quot;&gt;Vector Remap Language (VRL)&lt;&#x2F;a&gt; syntax, supporting numerous &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;functions&#x2F;&quot;&gt;functions&lt;&#x2F;a&gt;, making it easy to process logs as needed.&lt;&#x2F;li&gt;
&lt;li&gt;Offered convenient &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;unit-tests&#x2F;&quot;&gt;Unit Tests&lt;&#x2F;a&gt; to verify the correctness of VRL scripts.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;We decided to replace Promtail with Vector, following this process:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Migrate the existing Promtail configuration to Vector configuration: This included the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;sources&#x2F;kubernetes_logs&#x2F;&quot;&gt;Kubernetes logs source&lt;&#x2F;a&gt;, &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;sinks&#x2F;loki&#x2F;&quot;&gt;Loki sink&lt;&#x2F;a&gt;, and custom &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;remap&#x2F;&quot;&gt;Remap transform&lt;&#x2F;a&gt; components. We also wrote multiple Unit Tests to ensure the Vector configuration worked correctly.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sources&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;kubernetes_logs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;transforms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;add_metadata&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;remap&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;source&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;      # custom transformation by VRL
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sinks&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;Replace Promtail with Vector: Our replacement process was as follows:
&lt;ol&gt;
&lt;li&gt;First, synchronize Vector, during which the old Loki would temporarily handle double the traffic (Promtail + Vector).&lt;&#x2F;li&gt;
&lt;li&gt;Remove Promtail to avoid Loki&#x27;s rate limit errors affecting Vector.&lt;&#x2F;li&gt;
&lt;li&gt;Use Vector&#x27;s own retry mechanism to send logs to Loki normally.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;After the replacement, we observed that not only did Loki operate normally, but Vector also required less than 30% of the memory usage compared to Promtail, validating Vector&#x27;s high performance.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;gradually-increasing-sample-log-traffic&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#gradually-increasing-sample-log-traffic&quot; aria-label=&quot;Anchor link for: gradually-increasing-sample-log-traffic&quot;&gt;Gradually Increasing Sample Log Traffic&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Vector provides the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;sample&#x2F;&quot;&gt;Sample transform&lt;&#x2F;a&gt; feature, allowing us to set a sample rate to sample incoming logs. This is generally used in scenarios with extremely high log volumes, setting a small but sufficient sample rate for troubleshooting, reducing the burden on the log system and backend storage. However, we decided to leverage this feature to help us smoothly migrate Loki. The specific process is as follows:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Define the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;sample&#x2F;&quot;&gt;Sample transform&lt;&#x2F;a&gt;, inputting the &lt;code&gt;add_metadata&lt;&#x2F;code&gt; component processed by VRL. The following example uses a 10% (1&#x2F;10) sample rate.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;transforms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;add_metadata&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;remap&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;kubernetes_logs
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;source&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;|
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;      # custom transformation by VRL
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sample_log&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;sample
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    - &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;rate&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;10
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;Define a new Loki sink, changing the &lt;code&gt;endpoint&lt;&#x2F;code&gt; to the new Loki and the input to the &lt;code&gt;sample_log&lt;&#x2F;code&gt; component name. In the following example, &lt;code&gt;loki-v3&lt;&#x2F;code&gt; is the new Loki sink, and its input is &lt;code&gt;sample_log&lt;&#x2F;code&gt; instead of &lt;code&gt;add_metadata&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;sinks&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;add_metadata &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;loki-v3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;type&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;loki
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;inputs&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;sample_log &lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;endpoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;${LOKI_V3_ENDPOINT}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;tenant_id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .tenant_id }}&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;encoding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;codec&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;raw_message
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;*&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;{{ .loki_labels }}&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;
&lt;p&gt;Synchronize the Vector configuration to the cluster, confirming that the new Loki is receiving a small amount of logs from the real environment. At this point, we can focus on tuning Loki.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;As Loki tuning progresses, gradually increase the sample rate from 10%, 33%, 50% to the final 100%, proving that the new Loki can robustly handle production log traffic.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h3 id=&quot;improving-loki-labels&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#improving-loki-labels&quot; aria-label=&quot;Anchor link for: improving-loki-labels&quot;&gt;Improving Loki Labels&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;When using Promtail as the log collector, we set the following labels:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;cluster: k8s cluster name&lt;&#x2F;li&gt;
&lt;li&gt;namespace: k8s namespace&lt;&#x2F;li&gt;
&lt;li&gt;container: pod container name defined in &lt;code&gt;spec.containers.name&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;app: &lt;code&gt;app.kubernetes.io&#x2F;name&lt;&#x2F;code&gt;, &lt;code&gt;app&lt;&#x2F;code&gt; pod labels, or pod name&lt;&#x2F;li&gt;
&lt;li&gt;component: &lt;code&gt;app.kubernetes.io&#x2F;component&lt;&#x2F;code&gt; or &lt;code&gt;component&lt;&#x2F;code&gt; pod labels&lt;&#x2F;li&gt;
&lt;li&gt;instance: &lt;code&gt;app.kubernetes.io&#x2F;instance&lt;&#x2F;code&gt; or &lt;code&gt;instance&lt;&#x2F;code&gt; pod labels&lt;&#x2F;li&gt;
&lt;li&gt;nodename: node name where the pod is deployed&lt;&#x2F;li&gt;
&lt;li&gt;pod: pod name&lt;&#x2F;li&gt;
&lt;li&gt;stream: log is &lt;code&gt;stderr&lt;&#x2F;code&gt; or &lt;code&gt;stdout&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;After thoroughly reading &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;blog&#x2F;2023&#x2F;12&#x2F;20&#x2F;the-concise-guide-to-grafana-loki-everything-you-need-to-know-about-labels&#x2F;&quot;&gt;The concise guide to Grafana Loki: Everything you need to know about labels&lt;&#x2F;a&gt;, we realized that our current label design was very inefficient for Loki storage and search. Therefore, we decided to significantly improve the labels.&lt;&#x2F;p&gt;
&lt;p&gt;We decided to remove high cardinality labels like &lt;code&gt;pod&lt;&#x2F;code&gt; and &lt;code&gt;nodename&lt;&#x2F;code&gt; and place them in &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;get-started&#x2F;labels&#x2F;structured-metadata&#x2F;?pg=blog&amp;amp;plcmt=body-txt&quot;&gt;structured metadata&lt;&#x2F;a&gt;. Although its retrieval speed is not as fast as labels, this approach aligns with official recommendations and can potentially speed up searches by introducing &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;operations&#x2F;bloom-filters&#x2F;&quot;&gt;Bloom Filters&lt;&#x2F;a&gt;. We also added labels like &lt;code&gt;availability_zone&lt;&#x2F;code&gt;, &lt;code&gt;nodepool&lt;&#x2F;code&gt;, and &lt;code&gt;trace_id&lt;&#x2F;code&gt; to aid in log searches.&lt;&#x2F;p&gt;
&lt;p&gt;We made special adjustments to the &lt;code&gt;app&lt;&#x2F;code&gt; label. Besides the aforementioned app-related pod labels, if the pod had a parent resource (e.g., daemonset, statefulset, or deployment), we extracted the pod owner&#x27;s field, processed it, and wrote it into the &lt;code&gt;app&lt;&#x2F;code&gt; label.&lt;&#x2F;p&gt;
&lt;p&gt;We also made special adjustments for pods generated by k8s client libraries or controllers. These are usually one-time job tasks or pods without parent resources but with complex suffixes in their names. In such cases, we need to actively check which &lt;code&gt;app&lt;&#x2F;code&gt; labels have not been processed. The following &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;grafana.com&#x2F;docs&#x2F;loki&#x2F;latest&#x2F;query&#x2F;logcli&#x2F;logcli-tutorial&#x2F;#checking-series-cardinality&quot;&gt;logcli&lt;&#x2F;a&gt; command can help identify streams with unprocessed labels in different Loki tenants.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span&gt;LOKI_ADDR&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt;loki-gateway&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;export &lt;&#x2F;span&gt;&lt;span&gt;LOKI_ORG_ID&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&amp;lt;&lt;&#x2F;span&gt;&lt;span&gt;tenant-id&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;logcli&lt;&#x2F;span&gt;&lt;span&gt; series &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;#39;{}&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;After these operations, we expected to see two significant changes in the &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;grafana&#x2F;loki&#x2F;blob&#x2F;main&#x2F;production&#x2F;loki-mixin-compiled&#x2F;dashboards&#x2F;loki-operational.json&quot;&gt;Loki Operational Dashboard&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h4 id=&quot;streams&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#streams&quot; aria-label=&quot;Anchor link for: streams&quot;&gt;Streams&lt;&#x2F;a&gt;&lt;&#x2F;h4&gt;
&lt;p&gt;The results below show that the number of streams written decreased significantly from a peak of 20K to 3K. This change in stream numbers will improve chunk utilization, as explained later.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;993ccf977b9b4e8ca123c7400113cc0f.png?updatedAt=1739524948000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;c0aab6613b19447ba19aae6ee8d395c5.png?updatedAt=1739524958000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h4 id=&quot;chunk-flush-reason&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#chunk-flush-reason&quot; aria-label=&quot;Anchor link for: chunk-flush-reason&quot;&gt;Chunk Flush Reason&lt;&#x2F;a&gt;&lt;&#x2F;h4&gt;
&lt;p&gt;The chart below shows that the &lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason increased from 70% to over 90%. In theory, the total log volume remains unchanged, but the reduced number of streams means each stream needs to handle more logs, accelerating chunk writes and leading to more &lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reasons.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;2e73cc7626fd41259a3cc4e6edba98ba.png?updatedAt=1739524974000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;61d1990e3bb3496f9b1dcbff3cf59b1e.png?updatedAt=1739524983000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h2 id=&quot;results&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#results&quot; aria-label=&quot;Anchor link for: results&quot;&gt;Results&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;In addition to the increased &lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason and reduced stream numbers, improving Loki labels brought the following benefits.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;higher-ingester-write-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#higher-ingester-write-performance&quot; aria-label=&quot;Anchor link for: higher-ingester-write-performance&quot;&gt;Higher Ingester Write Performance&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;The table below shows the resource differences required for Ingester before and after improving Loki labels. The number of Ingester replicas decreased to about 30% of the original, and memory usage decreased to less than 25%. Since we set pod anti-affinity for Ingesters, the number of worker nodes matches the number of Ingesters, saving an estimated 70,000 yen per month.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;&lt;&#x2F;th&gt;&lt;th&gt;Ingester&#x27;s #replicas&lt;&#x2F;th&gt;&lt;th&gt;CPU core&lt;&#x2F;th&gt;&lt;th&gt;memory usage in GB&lt;&#x2F;th&gt;&lt;th&gt;dedicated worker node&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;Before&lt;&#x2F;td&gt;&lt;td&gt;30&lt;&#x2F;td&gt;&lt;td&gt;10&lt;&#x2F;td&gt;&lt;td&gt;90&lt;&#x2F;td&gt;&lt;td&gt;30&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;After&lt;&#x2F;td&gt;&lt;td&gt;12&lt;&#x2F;td&gt;&lt;td&gt;7.5&lt;&#x2F;td&gt;&lt;td&gt;21&lt;&#x2F;td&gt;&lt;td&gt;12&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h3 id=&quot;completely-eliminated-object-storage-rate-limit-occurrences&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#completely-eliminated-object-storage-rate-limit-occurrences&quot; aria-label=&quot;Anchor link for: completely-eliminated-object-storage-rate-limit-occurrences&quot;&gt;Completely Eliminated Object Storage Rate Limit Occurrences&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;Another benefit of improving Loki labels is the elimination of frequent &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;line-objects-internal.com&#x2F;notes-line-dev-files&#x2F;uploads&#x2F;02032190-a1f1-473e-9042-a2db60066052.png&quot;&gt;rate limit errors (429)&lt;&#x2F;a&gt; in Object Storage. The following charts show the differences in 4xx HTTP status code errors before and after the improvement, indicating that no errors occurred in the buckets used by the new Loki. We believe this is due to the high &lt;strong&gt;full&lt;&#x2F;strong&gt; Chunk Flush Reason in the new Loki, combined with Compactor compressing remaining unfilled chunks, resulting in almost all chunks being data-intensive. Compared to using multiple sparse chunks, fewer dense chunks can store the same log volume, reducing the number of Object Storage API requests during log queries and eliminating rate limits. Additionally, increasing the number of sharding buckets from 10 to 20 also helped.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Before&lt;&#x2F;th&gt;&lt;th&gt;After&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;5ba2e53b5b8d4963944d25be4c7cca9b.png?updatedAt=1739525018000&quot; width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;td&gt;&lt;img src=&quot;https:&#x2F;&#x2F;vos.line-scdn.net&#x2F;landpress-content-v2-vcfc68aynwenkh3bno0ixfx8&#x2F;24f2bcbf7e2c4fc588ad7342dbb39ece.png?updatedAt=1739525034000&quot;  width=&quot;700&quot; height=&quot;150&quot; &#x2F;&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#conclusion&quot; aria-label=&quot;Anchor link for: conclusion&quot;&gt;Conclusion&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;In this article, we introduced how we smoothly migrated the Loki cluster, especially by replacing Promtail with Vector and extensively using Vector&#x27;s powerful &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;vrl&#x2F;&quot;&gt;Vector Remap Language&lt;&#x2F;a&gt; and rich &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;components&#x2F;&quot;&gt;Vector Components&lt;&#x2F;a&gt;. This helped us migrate without affecting existing users and allowed the new Loki to receive logs from the production environment using sampling techniques.&lt;&#x2F;p&gt;
&lt;p&gt;With actual log traffic, we could focus on tuning the new Loki configuration. Following official recommendations, we made special adjustments to Loki labels, significantly reducing the resources needed for log writes and eliminating potential Object Storage burdens during log queries.&lt;&#x2F;p&gt;
&lt;p&gt;Additionally, Vector offers a &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;vector.dev&#x2F;docs&#x2F;reference&#x2F;configuration&#x2F;transforms&#x2F;log_to_metric&#x2F;&quot;&gt;Log to Metric Transform&lt;&#x2F;a&gt; feature that can directly convert numerical values recorded in logs into Prometheus metrics. We used this feature to improve our &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;techblog.lycorp.co.jp&#x2F;zh-hant&#x2F;grafana-alloy-best-practice&quot;&gt;previous Alloy experience&lt;&#x2F;a&gt;, replacing Loki Ruler and thereby reducing Loki&#x27;s load. It&#x27;s worth mentioning that I encountered some areas for improvement while using Vector and attempted to make some &lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;vectordotdev&#x2F;vector&#x2F;pulls?q=is%3Apr+is%3Amerged+author%3Atitaneric&quot;&gt;contributions to Vector&lt;&#x2F;a&gt;, hoping that Vector can develop even better.&lt;&#x2F;p&gt;
&lt;p&gt;Finally, the improvements to Loki labels mentioned earlier may cause potential loads on Loki&#x27;s Distributor and other components, requiring special tuning. More details on Loki configuration adjustments will be discussed in the next article. Stay tuned!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Grafana Alloy Best Practice</title>
          <pubDate>Sun, 04 Aug 2024 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/grafana-alloy-best-practice/</link>
          <guid>https://www.titaneric.com/posts/grafana-alloy-best-practice/</guid>
          <description xml:base="https://www.titaneric.com/posts/grafana-alloy-best-practice/">&lt;h1 id=&quot;tldr&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#tldr&quot; aria-label=&quot;Anchor link for: tldr&quot;&gt;TLDR&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;p&gt;引進Grafana Alloy及Faro Web SDK，增進RUM以及實現真正的前端到後端的完整tracing。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;jie-shao&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#jie-shao&quot; aria-label=&quot;Anchor link for: jie-shao&quot;&gt;介紹&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;p&gt;本文中會針對我在COSCUP 2024上報告的&quot;Grafana Alloy Best Practice: Achieving frontend RUM and E2E tracing&quot;做完整闡述。會介紹Grafana Alloy是甚麼以及它的功能，也提到我是如何引進並設計架構應付可能的巨大telemetry流量需求，提到了中間遇到的挑戰、對應的解決方式、成果及未來展望。在閱讀過程中可以搭配上面的投影片參考。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;ming-ci-jie-shao&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ming-ci-jie-shao&quot; aria-label=&quot;Anchor link for: ming-ci-jie-shao&quot;&gt;名詞介紹&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;real-user-monitoring-rum&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#real-user-monitoring-rum&quot; aria-label=&quot;Anchor link for: real-user-monitoring-rum&quot;&gt;Real User Monitoring (RUM)&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;RUM目的是要從前端網頁使用者或是瀏覽器上蒐集metrics，用以監控前端網的表現，發現潛在的錯誤，也可以用來追蹤使用者的行為(session)。Web vitals是由Google提出的指標，用來衡量用戶在網頁上的體驗，後面介紹的Faro SDK會一併蒐集web vitals，與錯誤及session等RUM相關資訊收進Grafana Alloy中。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;distributed-tracing&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#distributed-tracing&quot; aria-label=&quot;Anchor link for: distributed-tracing&quot;&gt;Distributed Tracing&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;用來描述一段請求在複雜且分散式系統中的完整流程，可以用來增進應用的可視性，除了可以知道請求在各個元件的消耗時間之外，也可以用來分析錯誤的發生原因。主流已經採用OpenTelemetry標準，它除了trace之外，也有針對log, metrics, profiling, core dump定義相關標準。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;grafana-alloy&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#grafana-alloy&quot; aria-label=&quot;Anchor link for: grafana-alloy&quot;&gt;Grafana Alloy&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Grafana Alloy是高效能，且有彈性的一種OpenTelemetry Collector。可以支援metrics, log以及trace等資料，也提供pipeline的方式，使用語法叫做alloy類似於Terraform HCL，用來描述這些資料該如何被處理，並且送進最終的目的端。在這篇文章中主要使用&lt;code&gt;faro.receiver&lt;&#x2F;code&gt;元件接受來自Faro Web SDK的資料。&lt;&#x2F;p&gt;
&lt;p&gt;註：相較於原始opentelemetry collector使用YAML定義資料流，我覺得alloy使用上比較直覺，也確實如官網所描述的，比較方便debug。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;grafana-faro-web-sdk&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#grafana-faro-web-sdk&quot; aria-label=&quot;Anchor link for: grafana-faro-web-sdk&quot;&gt;Grafana Faro Web SDK&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Grafana Faro是JS的library，可以引用在前端的應用中，用來蒐集前述的RUM及基本的metadata例如瀏覽器及OS名稱。也與opentelemetry-js整合，針對前端應用&lt;code&gt;fetch&lt;&#x2F;code&gt;及&lt;code&gt;XML&lt;&#x2F;code&gt;請求，會自動量測請求的trace。它也能將console log、error、event及&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Web&#x2F;API&#x2F;PerformanceResourceTiming&quot;&gt;performance resource timing&lt;&#x2F;a&gt;一起送進Grafana Alloy的Faro receiver中。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;xian-you-jia-gou&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#xian-you-jia-gou&quot; aria-label=&quot;Anchor link for: xian-you-jia-gou&quot;&gt;現有架構&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;p&gt;目前已經引進Grafana Alloy及Faro SDK進目前任職公司，在引進時需要考慮現有的架構，並思考如何整合。下面針對現有架構作介紹。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ji-shu-dui-die&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ji-shu-dui-die&quot; aria-label=&quot;Anchor link for: ji-shu-dui-die&quot;&gt;技術堆疊&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;在基本的infra上，底層是由OpenStack建立的私有雲架構，上層提供了Kubernetes、Load Balancer、Object Storage、Redis及MySQL等服務，這些infra主要由日本及韓國負責維運。&lt;&#x2F;p&gt;
&lt;p&gt;在這架構上，台灣的SRE在Kubernetes上部署了Traefik或Contour Ingress Controller，再上層的服務包含Tempo, Loki, ArgoCD, Grafana。&lt;&#x2F;p&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS?startSlide=18&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h2 id=&quot;ying-yong-tuan-dui-jian-kong-jia-gou&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ying-yong-tuan-dui-jian-kong-jia-gou&quot; aria-label=&quot;Anchor link for: ying-yong-tuan-dui-jian-kong-jia-gou&quot;&gt;應用團隊監控架構&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;應用團隊的服務也是部署在k8s上，前面的流量經過Load Balancer進來之後進到Traefik部署的那些節點上，Traefik聆聽Ingress或是IngressRoute設定的規則將流量送進服務內。&lt;&#x2F;p&gt;
&lt;p&gt;這些應用服務會產生log, metrics及trace。metrics抓取規則主要是由PodMonitor或者ServiceMonitor定義，收進cluster上的Agent mode的Prometheus(Statefulset部署)上，會進一步透過remote write機制送進其他團隊管理的Prometheus存放。&lt;&#x2F;p&gt;
&lt;p&gt;log主要會將stdout及stderr寫到節點上的log file上存放，我們使用promtail(Daemonset部暑)將這些log做前處理(加入敏感資料mask及k8s attributes等)之後，會直接送進SRE管理的Loki裡。&lt;&#x2F;p&gt;
&lt;p&gt;trace會先拋到cluster上的otel collector(Deployment部暑)上，一樣會先做些前處理(memory限制，限制每一個span的attributes數量等)，因為數量比較大我們選擇先拋到Kafka topic上，之後會在SRE cluster進行處理。&lt;&#x2F;p&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS?startSlide=19&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h2 id=&quot;srejian-kong-jia-gou&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#srejian-kong-jia-gou&quot; aria-label=&quot;Anchor link for: srejian-kong-jia-gou&quot;&gt;SRE監控架構&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;同樣在SRE cluster會部署Traefik負責接受監控的流量，上面如技術堆疊中提到的部署ArgoCD、Grafana、Tempo、Loki等服務。Grafana的資料來源主要是其他團隊管理的Prometheus，本地的Tempo及Loki，滿足metrics、log及trace的視覺化及告警需求。&lt;&#x2F;p&gt;
&lt;p&gt;在metrics部分，我們僅是使用Prometheus remote read功能讀取其他團隊的遠端Prometheus；在logs部分，透過Loki push API打進來的logs都會被Loki cluster消化，並存放到兼容S3 API的Object Storage中；SRE cluster上會另外部署一套otel collector，負責consume來自Kafka topic的trace，之後送進Tempo cluster進一步消化，也存在Object Storage中，&lt;&#x2F;p&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS?startSlide=20&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h1 id=&quot;ru-he-she-ji-alloy&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ru-he-she-ji-alloy&quot; aria-label=&quot;Anchor link for: ru-he-she-ji-alloy&quot;&gt;如何設計Alloy&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;xu-qiu&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#xu-qiu&quot; aria-label=&quot;Anchor link for: xu-qiu&quot;&gt;需求&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;在設計之前有一些基本的條件需要滿足&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;必要&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;充分利用並整合現有的監控平台&lt;&#x2F;li&gt;
&lt;li&gt;自動化且方便地部暑Alloy&lt;&#x2F;li&gt;
&lt;li&gt;因為Alloy會直接接收來自使用者最真實的流量，所以必須有基本的管控措施。&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;em&gt;非必要但有會更好&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;提供簡單的流程給應用團隊申請使用&lt;&#x2F;li&gt;
&lt;li&gt;提供範例程式串接Faro SDK，包含server-side rendering及client-side rendering&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;在申請流程方面，使用者目前能透過Slack workflow申請Alloy使用，會觸發一系列的自動化，使用者就能直接使用。我們也提供Nextjs的範例程式，也寫了教學文件，供前端應用的開發者能輕鬆地串接Faro SDK。接著會針對&lt;em&gt;必要&lt;&#x2F;em&gt;需求，設計Alloy的自動化以及Gateway架構。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ying-yong-tuan-dui-duan-de-alloyjia-gou&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ying-yong-tuan-dui-duan-de-alloyjia-gou&quot; aria-label=&quot;Anchor link for: ying-yong-tuan-dui-duan-de-alloyjia-gou&quot;&gt;應用團隊端的Alloy架構&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Alloy(Deployment部暑)本身是透過ArgoCD ApplicationSet方式部暑，我們抽離了各種跟應用團隊相關的設定成變數，在動態生成ArgoCD Application時能透過go template方式將各項設定填入Alloy的config，這些變數包含了cluster、團隊及namespace名稱等。&lt;&#x2F;p&gt;
&lt;p&gt;Alloy收進來的log是直接透過&lt;code&gt;loki.write&lt;&#x2F;code&gt;直接拋到SRE掌管的Loki cluster上；trace則是送到cluster上的otel collector，如前述說明的會將trace拋到Kafka上，之後會進到Tempo存放。&lt;&#x2F;p&gt;
&lt;p&gt;Alloy會開啟&lt;code&gt;faro.receiver&lt;&#x2F;code&gt;元件功能，在Alloy Deployment前面會掛一個k8s Service，不同於一般的ClusterIP，我們選擇LoadBalancer type，底層的controller聆聽到之後會自動在cluster前面再創建一個LoadBalancer，基本上這樣就可以供應用程式使用。不過Faro SDK蒐集到的telemetry資料並不是直接進入這個LB，前面會再經過一個gateway。&lt;&#x2F;p&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS?startSlide=23&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h2 id=&quot;sreduan-alloy-gatewayjia-gou&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#sreduan-alloy-gatewayjia-gou&quot; aria-label=&quot;Anchor link for: sreduan-alloy-gatewayjia-gou&quot;&gt;SRE端Alloy Gateway架構&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;為了能更方便的掌握各個團隊的telemetry流量，我們選擇在SRE的cluster上部暑Contour當作gateway，Contour的data plane是超高效能的Envoy，也提供了rate limit，如果必要我們可以針對某一些團隊的流量進行限流避免影響到gateway本身，以及對應用團隊cluster的衝擊。&lt;&#x2F;p&gt;
&lt;p&gt;我們使用了Contour提供的HTTPProxy，將相同domain但不同path的請求，送到應用團隊cluster的Alloy入口LB。也用了Endpoint及Service將Alloy入口LB的IP作為k8s service的封裝。&lt;&#x2F;p&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS?startSlide=24&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;&lt;h2 id=&quot;she-ji-yuan-you&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#she-ji-yuan-you&quot; aria-label=&quot;Anchor link for: she-ji-yuan-you&quot;&gt;設計緣由&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;Q: 為什麼使用統一的Alloy gateway，而不是每一個cluster有自己的ingress將流量送進Alloy?&lt;&#x2F;p&gt;
&lt;p&gt;A: 首先我們想要確實的掌握telemetry流量，有了gateway方便我們做監控，如果需要也可以充分利用Contour提供的rate limit功能。再來，我們想要區別一般應用及telemetry的流量，不希望telemetry流量衝擊到一般使用者使用。再者，如果要在每一個應用cluster的ingress進入流量，考量到不同的流量需要分開，就必須創建新的node，部暑新的Traefik，設定LB及DNS record，這需要應用團隊協助進行，這大大的增加佈署上的不便。最後，按照公司的規範，對外的服務需要經過Security Review，如果採用Alloy gateway，只要跑過一次就好，應用團隊也就不用每一個cluster都需要跑這個流程。&lt;&#x2F;p&gt;
&lt;p&gt;Q：為何選擇Contour當作Ingress Controller，而不用Traefik或者其他？&lt;&#x2F;p&gt;
&lt;p&gt;A：我們先前已經有使用過Contour的使用經驗，我們觀察到Contour以及Envoy的效能非常好，需要的記憶體與Traefik相比也少非常多。我們曾經考慮過Envoy自己出的Envoy Gateway，但可惜我們的k8s版本不太相符。也為了不要造成引入後帶來的維護及技術堆疊上的分歧。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;tiao-zhan&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#tiao-zhan&quot; aria-label=&quot;Anchor link for: tiao-zhan&quot;&gt;挑戰&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;因為Alloy會直接接收來自真實使用者的流量，不用經過CDN等其他cache機制，所以為了能應付潛在的巨大流量，我們針對Contour以及Alloy做了壓力測試，發現他們的效能以及表現都非常好。在流量控制上，我們有3層保護關卡：第一個是應用程式可以設定sample rate，決定多少比率的流量應該被送到Alloy gateway；第二個是使用Contour的rate limit功能，可以針對特定用戶或者全局的設定流量上限；最後一個是Alloy的&lt;code&gt;faro.receiver&lt;&#x2F;code&gt;也提供了rate limit功能，超過上限會回429。理想上這樣的層層保護設計可以保護SRE以及應用團隊的cluster。&lt;&#x2F;p&gt;
&lt;p&gt;Faro SDK蒐集到的資料最終會被送進Loki及Tempo中，我們為了因應潛在的巨大流量，也需要特別針對Loki及Tempo做性能調校，現有的監控平台是multi-tenant的設計，如果需要也可以針對不同的tenant設定rate limit。&lt;&#x2F;p&gt;
&lt;p&gt;Alloy將除了trace之外的資料全部透過log寫入Loki，這也包含了web vitals以及performance resource timing的數值型的資料，這雖然解決了Prometheus可能的high-cardinality問題，但這在資料視覺化上不太方便呈現。官方提供的Faro SDK dashboard是使用logql去拿到Loki的資料，當選取的時段一長，可能就會遇到載入過久的問題，在使用上少了各項metadata，所以呈現的數值都是粗糙的，沒有更為細緻的數據呈現。我們使用Loki ruler將常見的logql語法及metadata，轉化成Prometheus metrics，因為metadata也變成了metrics label之一，這樣就可以解決上述的問題，也能看到比如第118版應用程式在Mac的Arc瀏覽器的web vitals數值，供前端開發者效能優化的參考。&lt;&#x2F;p&gt;
&lt;p&gt;Faro SDK預設的trace propagation格式是使用W3C Trace Context，但是我們在應用團隊cluster佈署的Traefik僅支援Jaeger格式，如果要達成真正的前端到後端完整的tracing，一致的trace propagation是必要的，因為Traefik相對前端或後端應用不方便升級，所以造成前端或後端的應用需要配合Traefik的propagation格式，才能看到完整的tracing軌跡。應用團隊不僅會呼叫自己的服務，也可能呼叫第三方的API，這時如果第三方的API gateway將trace相關的HTTP Header（&lt;code&gt;TraceParent&lt;&#x2F;code&gt;或&lt;code&gt;Uber-Trace-Id&lt;&#x2F;code&gt;）移除，在那之後的tracing將不會被完整串接起來，我們在導入之後也發生這個狀況，在通知第三方服務不要過濾掉這些HTTP Header之後解決了這個issue。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;cheng-guo-ji-zhan-wang&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cheng-guo-ji-zhan-wang&quot; aria-label=&quot;Anchor link for: cheng-guo-ji-zhan-wang&quot;&gt;成果及展望&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;cheng-guo&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cheng-guo&quot; aria-label=&quot;Anchor link for: cheng-guo&quot;&gt;成果&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;目前團隊的telemetry資料會經過Loki ruler轉換成Prometheus metrics。應用團隊可以根據不同的metadata，例如app名稱、版本、環境、瀏覽器及OS版本的，看到不同的web vitals變化。同時也參考了Grafana Cloud，設計了session的dashboard，應用團隊可以看到不同的用戶在不同session的操作，了解用戶的使用行為。&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wei-lai-gong-zuo&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#wei-lai-gong-zuo&quot; aria-label=&quot;Anchor link for: wei-lai-gong-zuo&quot;&gt;未來工作&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;如前面提到的，Traefik受限的trace propagation格式造成了開發者的困擾，在Traefik v3之後統一使用OpenTelemetry及W3C Trace Context標準，我們預計將逐步升級上去。&lt;&#x2F;p&gt;
&lt;p&gt;在台灣這邊，應用團隊不管透過手動寫入或是library協助自動產生instrumentation都有累積一段經驗，但是採用的團隊仍不夠廣泛，而且應用團隊仍會需要手動在應用程式注入片段的程式碼才能發揮tracing功能，之後會研究zero-code instrumentation，例如Grafana Beyla這樣的工具，利用eBPF技術在底層追蹤請求及回覆，並轉換成trace。如此一來，團隊能更加專注開發應用，不須費盡心思撰寫instrumentation相關程式，也能享受tracing或其他監控帶來的好處。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;wan-zheng-tou-ying-pian&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#wan-zheng-tou-ying-pian&quot; aria-label=&quot;Anchor link for: wan-zheng-tou-ying-pian&quot;&gt;完整投影片&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;gxSQKJ88aLrpQS&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;</description>
      </item>
      <item>
          <title>The Journey to the Kubernetes Networkiing</title>
          <pubDate>Wed, 08 Feb 2023 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/the-journey-to-the-kubernetes-networking/</link>
          <guid>https://www.titaneric.com/posts/the-journey-to-the-kubernetes-networking/</guid>
          <description xml:base="https://www.titaneric.com/posts/the-journey-to-the-kubernetes-networking/">&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;r7psH28xitqtMZ&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;
&lt;p&gt;Still lost the following information.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;BGP&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;www.rfc-editor.org&#x2F;rfc&#x2F;rfc3927&quot;&gt;linked-local address&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;Ingress&lt;&#x2F;li&gt;
&lt;li&gt;API gateway&lt;&#x2F;li&gt;
&lt;li&gt;External Load Balancing&lt;&#x2F;li&gt;
&lt;li&gt;service mesh&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</description>
      </item>
      <item>
          <title>The Journey to the Kubernetes Metrics</title>
          <pubDate>Sun, 26 Dec 2021 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/the-journey-to-the-kubernetes-metrics/</link>
          <guid>https://www.titaneric.com/posts/the-journey-to-the-kubernetes-metrics/</guid>
          <description xml:base="https://www.titaneric.com/posts/the-journey-to-the-kubernetes-metrics/">&lt;div&gt;
    &lt;iframe src=&quot;&amp;#x2F;&amp;#x2F;www.slideshare.net&amp;#x2F;slideshow&amp;#x2F;embed_code&amp;#x2F;key&amp;#x2F;Hu3wS60GLyDXVk&quot; frameborder=&quot;0&quot; width=&quot;900&quot; height=&quot;600&quot;
        marginwidth=&quot;0&quot; marginheight=&quot;0&quot; scrolling=&quot;no&quot;
        style=&quot;border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;&quot; allowfullscreen&gt; &lt;&#x2F;iframe&gt;
&lt;&#x2F;div&gt;</description>
      </item>
      <item>
          <title>Kubernetes metrics-server</title>
          <pubDate>Sun, 10 Oct 2021 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://www.titaneric.com/posts/k8s-metrics-server/</link>
          <guid>https://www.titaneric.com/posts/k8s-metrics-server/</guid>
          <description xml:base="https://www.titaneric.com/posts/k8s-metrics-server/">&lt;h1 id=&quot;bei-jing&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#bei-jing&quot; aria-label=&quot;Anchor link for: bei-jing&quot;&gt;背景&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;p&gt;&lt;strong&gt;metrics-server&lt;&#x2F;strong&gt;是kubernetes用來量測cluster中node以及pod中的CPU以及記憶體使用率的工具，這些被量測到的資訊會被kubectl top以及HPA controller收集，分別做為查看目前k8s系統狀態以及擴充服務的依據。&lt;&#x2F;p&gt;
&lt;p&gt;metrics-server本身也如同k8s的絕大多數物件一樣，它是以web service的形式存在k8s當中，原始碼在&lt;a rel=&quot;noreferrer&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;kubernetes-sigs&#x2F;metrics-server&quot;&gt;kubernetes-sigs&#x2F;metrics-server&lt;&#x2F;a&gt;，本篇文章要來解析metrics-server中entry point、所使用的metrics基本物件、metrics如何被收集以及何時會被更新。&lt;&#x2F;p&gt;
&lt;h1 id=&quot;dive-in&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#dive-in&quot; aria-label=&quot;Anchor link for: dive-in&quot;&gt;Dive in&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;entry-point&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#entry-point&quot; aria-label=&quot;Anchor link for: entry-point&quot;&gt;Entry point&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;metrics-server在build過後，是用Docker image的形式將服務包裝成在k8s中運行的container。在原始碼當中的根目錄中，Dockerfile先是執行&lt;code&gt;make metrics-server&lt;&#x2F;code&gt;將metrics-server build成binary file，最後在entrypoint運行&lt;code&gt;cmd&#x2F;metrics-server&lt;&#x2F;code&gt;。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;Dockerfile&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-Dockerfile &quot;&gt;&lt;code class=&quot;language-Dockerfile&quot; data-lang=&quot;Dockerfile&quot;&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;WORKDIR &#x2F;go&#x2F;src&#x2F;sigs.k8s.io&#x2F;metrics-server
&lt;&#x2F;span&gt;&lt;span&gt;COPY go.mod .
&lt;&#x2F;span&gt;&lt;span&gt;COPY go.sum .
&lt;&#x2F;span&gt;&lt;span&gt;RUN go mod download
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;COPY pkg pkg
&lt;&#x2F;span&gt;&lt;span&gt;COPY cmd cmd
&lt;&#x2F;span&gt;&lt;span&gt;COPY Makefile Makefile
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;RUN make metrics-server
&lt;&#x2F;span&gt;&lt;span&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;ENTRYPOINT [&amp;quot;&#x2F;metrics-server&amp;quot;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;Makefile&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-Makefile &quot;&gt;&lt;code class=&quot;language-Makefile&quot; data-lang=&quot;Makefile&quot;&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;metrics-server&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;SRC_DEPS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;	GOARCH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ARCH&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;) &lt;&#x2F;span&gt;&lt;span&gt;CGO_ENABLED&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;0 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;go&lt;&#x2F;span&gt;&lt;span&gt; build&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -ldflags &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;$(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;LDFLAGS&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt; -o&lt;&#x2F;span&gt;&lt;span&gt; metrics-server sigs.k8s.io&#x2F;metrics-server&#x2F;cmd&#x2F;metrics-server
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;在上面Makefile可以看到，go build的來源是metrics-server下的&lt;code&gt;cmd&#x2F;metrics-server&lt;&#x2F;code&gt;，該目錄下的metrics-server.go執行在&lt;code&gt;cmd&#x2F;metrics-server&#x2F;app&lt;&#x2F;code&gt;中定義的cobra指令。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;sigs.k8s.io&#x2F;metrics-server&#x2F;cmd&#x2F;metrics-server&#x2F;app&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	cmd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;app&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewMetricsServerCommand&lt;&#x2F;span&gt;&lt;span&gt;(genericapiserver&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;SetupSignalHandler&lt;&#x2F;span&gt;&lt;span&gt;())
&lt;&#x2F;span&gt;&lt;span&gt;	cmd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Flags&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;AddGoFlagSet&lt;&#x2F;span&gt;&lt;span&gt;(flag&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;CommandLine)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;cmd&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Execute&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;; &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;!= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;panic&lt;&#x2F;span&gt;&lt;span&gt;(err)
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;在&lt;code&gt;cmd&#x2F;metrics-server&#x2F;app&#x2F;metrics-server.go&lt;&#x2F;code&gt;中的&lt;code&gt;NewMetricsServerCommand()&lt;&#x2F;code&gt;function用到&lt;code&gt;cmd&#x2F;metrics-server&#x2F;app&#x2F;options&#x2F;options.go&lt;&#x2F;code&gt;中定義的&lt;code&gt;NewOptions()&lt;&#x2F;code&gt; function。定義metrics-server需要用到的設定&lt;code&gt;Options&lt;&#x2F;code&gt; struct，該設定會傳給&lt;code&gt;runCommand()&lt;&#x2F;code&gt; function最後透過cobra的&lt;code&gt;Execute()&lt;&#x2F;code&gt; method執行。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;sigs.k8s.io&#x2F;metrics-server&#x2F;cmd&#x2F;metrics-server&#x2F;app&#x2F;options&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; NewMetricsServerCommand provides a CLI handler for the metrics server entrypoint
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewMetricsServerCommand&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;stopCh &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;lt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;chan struct&lt;&#x2F;span&gt;&lt;span&gt;{}) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;cobra&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Command &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	opts &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;options&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewOptions&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	cmd &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;cobra&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Command{
&lt;&#x2F;span&gt;&lt;span&gt;		Short&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Launch metrics-server&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		Long&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Launch metrics-server&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		RunE&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;c &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;cobra&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Command&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;args &lt;&#x2F;span&gt;&lt;span&gt;[]&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;runCommand&lt;&#x2F;span&gt;&lt;span&gt;(opts&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;stopCh)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;; &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;!= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;				&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;err
&lt;&#x2F;span&gt;&lt;span&gt;			}
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil
&lt;&#x2F;span&gt;&lt;span&gt;		}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;cmd
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;下面的ServerConfig method回傳定義在&lt;code&gt;pkg&#x2F;server&lt;&#x2F;code&gt;中定義的&lt;code&gt;Config&lt;&#x2F;code&gt; struct，會被當作web service需要的參數最後在&lt;code&gt;Complete()&lt;&#x2F;code&gt; method中回傳&lt;code&gt;Server&lt;&#x2F;code&gt; struct，即是metrics-server自身的web server，一直執行該server直到收到stop signal為止，這樣程式的進入點就結束了，接著細部看各項server設定以及metrics用到的struct。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;runCommand&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;o &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;options&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Options&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;stopCh &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;lt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;chan struct&lt;&#x2F;span&gt;&lt;span&gt;{}) &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;o&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;ServerConfig&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Complete&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;RunUntil&lt;&#x2F;span&gt;&lt;span&gt;(stopCh)
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;metricsji-ben-wu-jian&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#metricsji-ben-wu-jian&quot; aria-label=&quot;Anchor link for: metricsji-ben-wu-jian&quot;&gt;metrics基本物件&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;h3 id=&quot;servercan-shu&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#servercan-shu&quot; aria-label=&quot;Anchor link for: servercan-shu&quot;&gt;Server參數&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;前面有提過&lt;code&gt;NewOptions()&lt;&#x2F;code&gt; function會回傳&lt;code&gt;Options&lt;&#x2F;code&gt; struct，裡面有&lt;code&gt;MetricResolution&lt;&#x2F;code&gt;，該項目定義了metrics-server多久抓一次在node及pod中的metrics，預設是60秒抓一次。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewOptions&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Options &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;Options{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;		KubeletClient&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewKubeletClientOptions&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		MetricResolution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;60 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span&gt;time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Second&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;Options &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	KubeletClient  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;KubeletClientOptions
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	MetricResolution time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Duration
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;在&lt;code&gt;runCommand()&lt;&#x2F;code&gt;function中會使用&lt;code&gt;ServerConfig()&lt;&#x2F;code&gt;method建立Config，&lt;code&gt;MetricResolution&lt;&#x2F;code&gt;即是剛才在Options中定義的，&lt;code&gt;ScrapeTimeout&lt;&#x2F;code&gt;是抓取後隔多久會發生timeout的情形，預設是&lt;code&gt;MetricResolution&lt;&#x2F;code&gt;*0.9。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;o &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Options&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;ServerConfig&lt;&#x2F;span&gt;&lt;span&gt;() (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;server&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Config&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;server&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Config{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;		MetricResolution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;o&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;MetricResolution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		ScrapeTimeout&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:    &lt;&#x2F;span&gt;&lt;span&gt;time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Duration&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;float64&lt;&#x2F;span&gt;&lt;span&gt;(o&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;MetricResolution) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;90&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; scrape timeout is 90% of the scrape interval
&lt;&#x2F;span&gt;&lt;span&gt;	}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;Config &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	Apiserver        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;genericapiserver&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Config
&lt;&#x2F;span&gt;&lt;span&gt;	Rest             &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;rest&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Config
&lt;&#x2F;span&gt;&lt;span&gt;	Kubelet          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;client&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;KubeletClientConfig
&lt;&#x2F;span&gt;&lt;span&gt;	MetricResolution time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Duration
&lt;&#x2F;span&gt;&lt;span&gt;	ScrapeTimeout    time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Duration
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;metricszhua-qu-wu-jian&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#metricszhua-qu-wu-jian&quot; aria-label=&quot;Anchor link for: metricszhua-qu-wu-jian&quot;&gt;metrics抓取物件&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;scraper&lt;&#x2F;code&gt;是真正向node以及pods抓取metrics的必要物件，裡面有一項是實現了&lt;code&gt;KubeletMetricsInterface&lt;&#x2F;code&gt;的&lt;code&gt;kubeletClient&lt;&#x2F;code&gt;，另外的&lt;code&gt;scrapeTimeout&lt;&#x2F;code&gt;即是前面&lt;code&gt;Config&lt;&#x2F;code&gt; struct的&lt;code&gt;ScrapeTimeout&lt;&#x2F;code&gt;，scraper會每隔&lt;code&gt;scrapeTimeout&lt;&#x2F;code&gt;定時透過&lt;code&gt;kubeletClient&lt;&#x2F;code&gt;跟kubelet要資料。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;scraper &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	nodeLister    v1listers&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NodeLister
&lt;&#x2F;span&gt;&lt;span&gt;	kubeletClient client&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;KubeletMetricsInterface
&lt;&#x2F;span&gt;&lt;span&gt;	scrapeTimeout time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Duration
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;MetricsBatch&lt;&#x2F;code&gt;是scraper抓到metrics後回傳的物V，包含了針對node以及pod的metrics，&lt;code&gt;Nodes&lt;&#x2F;code&gt;是node名稱映到MetricsPoint的map；&lt;code&gt;Pods&lt;&#x2F;code&gt;是namespace映到container名稱再映到MetricsPoint的map。MetricsPoint包含&lt;code&gt;CumulativeCpuUsed&lt;&#x2F;code&gt;及&lt;code&gt;MemoryUsage&lt;&#x2F;code&gt;兩個CPU以及Memory的使用率。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; MetricsBaVch is a single batch of pod, container, and node metrics from some source.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;MetricsBatch &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	Nodes &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;	Pods  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[apitypes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NamespacedName&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;PodMetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; PodMetricsPoint contains the metrics for some pod&amp;#39;s containers.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;PodMetricsPoint &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	Containers &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; MetricsPoint represents the a set of specific metrics at some point in time.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;MetricsPoint &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	Timestamp time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Time
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; CumulativeCpuUsed is the cumulative cpu used at Timestamp from the StartTime of container&#x2F;node. Unit: nano core * seconds.
&lt;&#x2F;span&gt;&lt;span&gt;	CumulativeCpuUsed &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;uint64
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; MemoryUsage is the working set size. Unit: bytes.
&lt;&#x2F;span&gt;&lt;span&gt;	MemoryUsage &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;uint64
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;metricscun-fang-wu-jian&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#metricscun-fang-wu-jian&quot; aria-label=&quot;Anchor link for: metricscun-fang-wu-jian&quot;&gt;metrics存放物件&lt;&#x2F;a&gt;&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;storage&lt;&#x2F;code&gt;存放的是前面&lt;code&gt;scraper&lt;&#x2F;code&gt;收集而來的metrics，並有個別分&lt;code&gt;podStorage&lt;&#x2F;code&gt;以及&lt;code&gt;nodeStorage&lt;&#x2F;code&gt;。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; nodeStorage is a thread save nodeStorage for node and pod metrics.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;storage &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	mu    sync&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;RWMutex
&lt;&#x2F;span&gt;&lt;span&gt;	pods  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;podStorage
&lt;&#x2F;span&gt;&lt;span&gt;	nodes &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;nodeStorage
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;從下面的&lt;code&gt;podStorage&lt;&#x2F;code&gt;以及&lt;code&gt;nodeStorage&lt;&#x2F;code&gt;可以注意到這兩個struct都有存放last以及prev兩個metrics，即是現在的metrics內容以及上次抓到的metrics內容，之後會根據兩者metrics差異計算資源的使用率。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;podStorage &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; last stores pod metric points from last scrape
&lt;&#x2F;span&gt;&lt;span&gt;	last &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[apitypes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NamespacedName&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;PodMetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; prev sVores pod metric points from scrape preceding the last one.
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; Points timestamp should proceed the corresponding points from last and have same start time (no restart between them).
&lt;&#x2F;span&gt;&lt;span&gt;	prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[apitypes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NamespacedName&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;PodMetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; scrape period of metrics server
&lt;&#x2F;span&gt;&lt;span&gt;	metricResolution time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Duration
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;nodeStorage &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; last stores node metric points from last scrape
&lt;&#x2F;span&gt;&lt;span&gt;	last &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; prev stores node metric points from scrape preceding the last one.
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; Points timestamp should proceed the corresponding points from last.
&lt;&#x2F;span&gt;&lt;span&gt;	prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;metricsshou-ji&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#metricsshou-ji&quot; aria-label=&quot;Anchor link for: metricsshou-ji&quot;&gt;metrics收集&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;同樣在&lt;code&gt;runCommand&lt;&#x2F;code&gt;中的，取得&lt;code&gt;Config&lt;&#x2F;code&gt; instance之後，會呼叫&lt;code&gt;Complete&lt;&#x2F;code&gt; method建立&lt;code&gt;Server&lt;&#x2F;code&gt; instance。其中有兩個很重要的物件，一個是名為&lt;code&gt;scrape&lt;&#x2F;code&gt;的&lt;code&gt;scraper&lt;&#x2F;code&gt; instance，主要負責進行node及pod metrics的抓取，所以要將&lt;code&gt;ScrapeTimeout&lt;&#x2F;code&gt;傳給它；另外一個是&lt;code&gt;storage&lt;&#x2F;code&gt; instance，就跟它的名字一樣主要負責存放抓下來的metrics。&lt;&#x2F;p&gt;
&lt;p&gt;另外要注意的是，&lt;code&gt;kubeletClient&lt;&#x2F;code&gt;也會被建立出來傳給&lt;code&gt;scrape&lt;&#x2F;code&gt;，真正拿metrics是透過這個client去跟kubelet拿，會在之後做說明。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;c &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Config&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Complete&lt;&#x2F;span&gt;&lt;span&gt;() (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;server&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	kubeletClient&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;resource&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewClient&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Kubelet)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	nodes &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;informer&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Core&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;V1&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Nodes&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	scrape &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;scraper&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewScraper&lt;&#x2F;span&gt;&lt;span&gt;(nodes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Lister&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;kubeletClient&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;ScrapeTimeout)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	store &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewStorage&lt;&#x2F;span&gt;&lt;span&gt;(c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;MetricResolution)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewServer&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;		store&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		scrape&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;MetricResolution&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;在建立完&lt;code&gt;Server&lt;&#x2F;code&gt; instance之後，最終會執行&lt;code&gt;RunUntil&lt;&#x2F;code&gt; method，它會起一個go routine執行&lt;code&gt;runScrape&lt;&#x2F;code&gt; method進行metrics的抓取及存放。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; RunUntil starts background scraping goroutine and runs apiserver serving metrics.
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;server&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;RunUntil&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;stopCh &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;lt;-&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;chan struct&lt;&#x2F;span&gt;&lt;span&gt;{}) &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; Start serving API and scrape loop
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;go &lt;&#x2F;span&gt;&lt;span&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;runScrape&lt;&#x2F;span&gt;&lt;span&gt;(ctx)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;runScrape&lt;&#x2F;code&gt; method會利用&lt;code&gt;NewTicker&lt;&#x2F;code&gt;建立一個ticker，當中包含一個channel，每隔&lt;code&gt;resolution&lt;&#x2F;code&gt;時間後，ticker會敲一次並把時間傳給channel。之後會進行無窮迴圈，從channel中取得當前時間，並呼叫&lt;code&gt;tick&lt;&#x2F;code&gt; method執行核心的metrics抓取。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;server&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;runScrape&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ctx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Context&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	ticker &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewTicker&lt;&#x2F;span&gt;&lt;span&gt;(s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;resolution)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;defer &lt;&#x2F;span&gt;&lt;span&gt;ticker&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Stop&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;(ctx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Now&lt;&#x2F;span&gt;&lt;span&gt;())
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;select &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;case &lt;&#x2F;span&gt;&lt;span&gt;startTime &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &amp;lt;-&lt;&#x2F;span&gt;&lt;span&gt;ticker&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;C&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;			s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;(ctx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;startTime)
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;case &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;lt;-&lt;&#x2F;span&gt;&lt;span&gt;ctx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Done&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return
&lt;&#x2F;span&gt;&lt;span&gt;		}
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;剛才在&lt;code&gt;Complete&lt;&#x2F;code&gt; method中定義的scraper以及storage instance就是在這裡會被呼叫到。scraper會呼叫&lt;code&gt;Scrape&lt;&#x2F;code&gt; method抓取metrics，回傳的metrics內容是&lt;code&gt;MetricsBatch&lt;&#x2F;code&gt; instance。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;server&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ctx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;startTime &lt;&#x2F;span&gt;&lt;span&gt;time&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Time&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;V&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;6&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;InfoS&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Scraping metrics&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;	data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;scraper&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Scrape&lt;&#x2F;span&gt;&lt;span&gt;(ctx)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;V&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;6&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;InfoS&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Storing metrics&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(data)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;scraper的&lt;code&gt;Scraper&lt;&#x2F;code&gt; method會對node以及pod進行metrics的抓取，首先列出所有的nodes之後，建立一個大小為nodes數量的&lt;code&gt;responseChannel&lt;&#x2F;code&gt;存放收集而來的metrics。之後針對nodes中個別的node起一個go routine，並呼叫&lt;code&gt;collectNode&lt;&#x2F;code&gt; method，針對node拿對應的metrics，非同步地將回傳結果放入剛才建立的&lt;code&gt;responseChannel&lt;&#x2F;code&gt;。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;c &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;scraper&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Scrape&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;baseCtx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;C&lt;&#x2F;span&gt;&lt;span&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ntext&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	nodes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;nodeLister&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;List&lt;&#x2F;span&gt;&lt;span&gt;(labels&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Everything&lt;&#x2F;span&gt;&lt;span&gt;())
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;V&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;InfoS&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Scraping metrics from nodes&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;nodeCount&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(nodes))
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	responseChannel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;chan &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(nodes))
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;defer &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;close&lt;&#x2F;span&gt;&lt;span&gt;(responseChannel)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;_&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;node &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;range &lt;&#x2F;span&gt;&lt;span&gt;nodes {
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;go func&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;node &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;corev1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;			klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;V&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;InfoS&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Scraping node&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;node&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;KObj&lt;&#x2F;span&gt;&lt;span&gt;(node))
&lt;&#x2F;span&gt;&lt;span&gt;			m&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;collectNode&lt;&#x2F;span&gt;&lt;span&gt;(ctx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;node)
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;			responseChannel &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;lt;- &lt;&#x2F;span&gt;&lt;span&gt;m
&lt;&#x2F;span&gt;&lt;span&gt;		}(node)
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;collectNode&lt;&#x2F;code&gt; method會透過剛在&lt;code&gt;Complete&lt;&#x2F;code&gt; method中建立的&lt;code&gt;kubeletClient&lt;&#x2F;code&gt;跟kubelet拿node的metrics。&lt;code&gt;kubeletClient&lt;&#x2F;code&gt;實現了&lt;code&gt;KubeletMetricsInterface&lt;&#x2F;code&gt;，並透過RESTful API去跟kubelet拿metrics。kubelet如何實現這部分有點超出本文範圍等之後再來trace。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;c &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;scraper&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;collectNode&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ctx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;node &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;corev1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;) (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	ms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;c&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;kubeletClient&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;GetMetrics&lt;&#x2F;span&gt;&lt;span&gt;(ctx&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;node)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;ms&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; KubeletMetricsInterface knows how to fetch metrics from the Kubelet
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#399ee6;&quot;&gt;KubeletMetricsInterface &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;interface &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; GetMetrics fetches Resource metrics from the given Kubelet
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;GetMetrics&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ctx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;node &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;v1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;) (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F;GetMetrics get metrics from kubelet &#x2F;metrics&#x2F;resource endpoint
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;kc &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;kubeletClient&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;GetMetrics&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;ctx &lt;&#x2F;span&gt;&lt;span&gt;context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Context&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;node &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;corev1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;Node&lt;&#x2F;span&gt;&lt;span&gt;) (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;storage&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	port &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;kc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;defaultPort
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	addr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;kc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;addrResolver&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NodeAddress&lt;&#x2F;span&gt;&lt;span&gt;(node)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;!= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;	url &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;url&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;URL{
&lt;&#x2F;span&gt;&lt;span&gt;		Scheme&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;kc&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;scheme&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		Host&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:   &lt;&#x2F;span&gt;&lt;span&gt;net&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;JoinHostPort&lt;&#x2F;span&gt;&lt;span&gt;(addr&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;strconv&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Itoa&lt;&#x2F;span&gt;&lt;span&gt;(port))&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;		Path&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;:   &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;&#x2F;metrics&#x2F;resource&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	req&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;err &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;http&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;NewRequest&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;GET&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;url&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;()&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;metricschu-fang&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#metricschu-fang&quot; aria-label=&quot;Anchor link for: metricschu-fang&quot;&gt;metrics儲放&lt;&#x2F;a&gt;&lt;&#x2F;h2&gt;
&lt;p&gt;接下來要看存放metrics的&lt;code&gt;Store&lt;&#x2F;code&gt; method，這裡會針對nodes以及pods個別呼叫&lt;code&gt;Store&lt;&#x2F;code&gt; method。同時也會更新物件中的last以及prev內容。&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;storage&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;batch &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;mu&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Lock&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;defer &lt;&#x2F;span&gt;&lt;span&gt;s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;mu&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Unlock&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;nodes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(batch)
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;pods&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(batch)
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;nodeStorage&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;batch &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	lastNodes &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(batch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Nodes))
&lt;&#x2F;span&gt;&lt;span&gt;	prevNodes &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;string&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsPoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(batch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Nodes))
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;nodeName&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;newPoint &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;range &lt;&#x2F;span&gt;&lt;span&gt;batch&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Nodes {
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;_&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;exists &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span&gt;lastNodes[nodeName]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;; &lt;&#x2F;span&gt;&lt;span&gt;exists {
&lt;&#x2F;span&gt;&lt;span&gt;			klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;ErrorS&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;nil&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;Got duplicate node point&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;node&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;klog&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;KRef&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;nodeName))
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;continue
&lt;&#x2F;span&gt;&lt;span&gt;		}
&lt;&#x2F;span&gt;&lt;span&gt;		lastNodes[nodeName] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;newPoint
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;last &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;lastNodes
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;prevNodes
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; Only count last for which metrics can be returned.
&lt;&#x2F;span&gt;&lt;span&gt;	pointsStored&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;WithLabelValues&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;node&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;float64&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(prevNodes)))
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;go&quot; style=&quot;background-color:#fafafa;color:#61676c;&quot; class=&quot;language-go &quot;&gt;&lt;code class=&quot;language-go&quot; data-lang=&quot;go&quot;&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;func &lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;s &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;podStorage&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Store&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;newPods &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;MetricsBatch&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;	lastPods &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[apitypes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NamespacedName&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;PodMetricsPoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(newPods&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Pods))
&lt;&#x2F;span&gt;&lt;span&gt;	prevPods &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;make&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;map&lt;&#x2F;span&gt;&lt;span&gt;[apitypes&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;NamespacedName&lt;&#x2F;span&gt;&lt;span&gt;]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;PodMetricsPoint&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(newPods&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Pods))
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;var &lt;&#x2F;span&gt;&lt;span&gt;containerCount &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;int
&lt;&#x2F;span&gt;&lt;span&gt;	&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;podRef&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;newPod &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;range &lt;&#x2F;span&gt;&lt;span&gt;newPods&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Pods {
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;containerName&lt;&#x2F;span&gt;&lt;span style=&quot;color:#61676ccc;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span&gt;newPoint &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;range &lt;&#x2F;span&gt;&lt;span&gt;newPod&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Containers {
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;			newLastPod&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Containers[containerName] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;newPoint
&lt;&#x2F;span&gt;&lt;span&gt;			&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;		}
&lt;&#x2F;span&gt;&lt;span&gt;		containerPoints &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;:= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f07171;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;(newPrevPod&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;Containers)
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;color:#fa6e32;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span&gt;containerPoints &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ff8f40;&quot;&gt;0 &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;			prevPods[podRef] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;newPrevPod
&lt;&#x2F;span&gt;&lt;span&gt;		}
&lt;&#x2F;span&gt;&lt;span&gt;		lastPods[podRef] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;newLastPod
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;		&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#abb0b6;&quot;&gt;&#x2F;&#x2F; Only count containers for which metrics can be returned.
&lt;&#x2F;span&gt;&lt;span&gt;		containerCount &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span&gt;containerPoints
&lt;&#x2F;span&gt;&lt;span&gt;	}
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;last &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;lastPods
&lt;&#x2F;span&gt;&lt;span&gt;	s&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span&gt;prev &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;prevPods
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;	pointsStored&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;WithLabelValues&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#86b300;&quot;&gt;&amp;quot;container&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ed9366;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29718;&quot;&gt;Set&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#55b4d4;&quot;&gt;float64&lt;&#x2F;span&gt;&lt;span&gt;(containerCount))
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;jie-yu&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#jie-yu&quot; aria-label=&quot;Anchor link for: jie-yu&quot;&gt;結語&lt;&#x2F;a&gt;&lt;&#x2F;h1&gt;
&lt;p&gt;本篇文章trace了metrics-server的進入點、如何抓取nodes及pods的metrics以及如何存放剛抓到的metrics。metrics-server每隔一段時間就會抓取metrics，並存放到內部定義的資料結構中。其實&lt;code&gt;podStorage&lt;&#x2F;code&gt;以及&lt;code&gt;nodeStorage&lt;&#x2F;code&gt;還有一個method是&lt;code&gt;GetMetrics&lt;&#x2F;code&gt;，這之後會被kubectl top以及HPA controller呼叫到，該method會從這些資料結構中抓取metrics以及計算metrics差異，這會在之後的文章做說明。&lt;&#x2F;p&gt;
</description>
      </item>
    </channel>
</rss>
