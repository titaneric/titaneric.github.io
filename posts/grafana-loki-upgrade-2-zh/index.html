<!DOCTYPE html>
<html lang="en" class="dark light">

    <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base" content="https:&#x2F;&#x2F;www.titaneric.com">

    

    
    
    
        <title>
            
                Grafana Loki系列文章(II) - Loki寫入及讀取性能調校
            
        </title>

        
            <meta property="og:title"
                  content="Grafana Loki系列文章(II) - Loki寫入及讀取性能調校" />
        
    

    
        
    

    
        
    

    
    <link rel="icon" type="image/png" href=https://www.titaneric.com/icons/favicon-16x16.png />

    
    
        <link href=https://www.titaneric.com/fonts.css rel="stylesheet" />
    

    
    

    
    
        
            
            

            <script defer
                    src="/js/imamu.js"
                    data-website-id="63f9d7c5-7c47-493b-af29-481374c7531c"
                    data-host-url="https:&#x2F;&#x2F;api-gateway.umami.dev&#x2F;"></script>
        

        
    

    
    <script defer src=https://www.titaneric.com/js/codeblock.js></script>

    
    <script defer src=https://www.titaneric.com/js/toc.js></script>

    
    
        <script src=https://www.titaneric.com/js/note.js></script>
    

    
        
            <script>
            MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };
            </script>
        
        <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
        </script>
    

    
    


    
    
        <link rel="stylesheet"
              type="text/css"
              href="https://www.titaneric.com/theme/light.css" />
        <link id="darkModeStyle"
              rel="stylesheet"
              type="text/css"
              href="https://www.titaneric.com/theme/dark.css" />
    

    <!-- Set the correct theme in the script -->

    
        <script src=https://www.titaneric.com/js/themetoggle.js></script>

        
            <script>setTheme(getSavedTheme());</script>
        
    


    <link rel="stylesheet"
          type="text/css"
          media="screen"
          href="https://www.titaneric.com/main.css" />

    

    
        <script defer
                src="https://www.titaneric.com/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e"></script></head>


    <body>
        <div class="left-content">
            
            
        </div>

        <div class="content">
            <nav>
    <div class="left-nav">
        
            <a href=https:&#x2F;&#x2F;www.titaneric.com>titaneric</a>
        


        <div class="socials">
            
                <a rel="me" href="https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;chen-yi-huang&#x2F;" class="social">
                    <img alt="linkedin" src="https://www.titaneric.com/icons/social/linkedin.svg">
                </a>
            
                <a rel="me" href="https:&#x2F;&#x2F;github.com&#x2F;titaneric&#x2F;" class="social">
                    <img alt="github" src="https://www.titaneric.com/icons/social/github.svg">
                </a>
            
        </div>
    </div>

    <div class="right-nav">
        
            <a href=https://www.titaneric.com/posts style="margin-right: 0.5em">posts</a>
        
            <a href=https://www.titaneric.com/tags style="margin-right: 0.5em">tags</a>
        
            <a href=https://www.titaneric.com/categories style="margin-right: 0.5em">categories</a>
        
            <a href=https://www.titaneric.com/archive style="margin-right: 0.5em">archive</a>
        
            <a href=https://www.titaneric.com/pdfs/resume.pdf style="margin-right: 0.5em">about</a>
        
            <a href=https://www.titaneric.com/notes/index.html style="margin-right: 0.5em">notes</a>
        

        
            <button id="search-button"
                    class="search-button"
                    title="$SHORTCUT to open search">
                <img src="https://www.titaneric.com/icons/search.svg"
                    alt="Search"
                    class="search-icon">
            </button>

            <div id="searchModal"
                class="search-modal js"
                role="dialog"
                aria-labelledby="modalTitle">
                <div id="modal-content">
                    <h1 id="modalTitle" class="page-header">Search</h1>
                    <div id="searchBar">
                        <input id="searchInput"
                            role="combobox"
                            autocomplete="off"
                            spellcheck="false"
                            aria-expanded="false"
                            aria-controls="results-container"
                            placeholder="Search..." />
                        <button id="clear-search" class="clear-button" title="Clear search">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
                                <path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                            </svg>
                        </button>
                    </div>
                    <div id="results-container">
                        <div id="results-info">
                            <span id="zero_results" style="display: none;">No results</span>
                            <span id="one_result" style="display: none;">1 result</span>
                            <span id="many_results" style="display: none;">$NUMBER results</span>
                        </div>
                        <div id="results" role="listbox"></div>
                    </div>
                </div>
            </div>
        

        
            <a id="dark-mode-toggle"
            onclick="toggleTheme(); event.preventDefault();"
            href="#">
                <img src="https://www.titaneric.com/icons/sun.svg"
                    id="sun-icon"
                    style="filter: invert(1)"
                    alt="Light" />
                <img src=https://www.titaneric.com/icons/moon.svg id="moon-icon" alt="Dark" />
            </a>

            <!-- Initialize the theme toggle icons -->
            <script>updateItemToggleTheme()</script>
        
    </div>
</nav>


            
            
    
<div class="visible-element-observer-root" data-selector="main article p">
    <main>
        <article>
            <div class="title">
                
                
    
    <div class="page-header">
        Grafana Loki系列文章(II) - Loki寫入及讀取性能調校
    </div>
    


                <div class="meta">
                    
                        Posted on <time>2025-06-18</time>
                    


                    

                    

                    

                    
                    
                        
                        
                            
                        

                        
                            
                            :: <a href="https:&#x2F;&#x2F;github.com&#x2F;titaneric&#x2F;titaneric.github.io&#x2F;tree&#x2F;master&#x2F;content&#x2F;posts&#x2F;grafana-loki-upgrade-2.zh.md" target="_blank" rel="noopener noreferrer">Source Code</a>
                        
                    

                    
                    

                    
                    
                        <span class="tags-label"> :: </span>
                        <span class="tags">
                                <a href="https://www.titaneric.com/tags/k8s/"
                                   class="post-tag">k8s</a>
                            
                                <a href="https://www.titaneric.com/tags/monitoring/"
                                   class="post-tag">monitoring</a>
                            
                        </span>
                    

                    

                </div>
            </div>

            

            <section class="body">
                <p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/7ebbf0334cc14d71818a451b89847db8.png?updatedAt=1739524743000" alt="" />
<em><p style="text-align:center">Generated by Microsoft Designer</p></em></p>
<h2 id="bei-jing"><a class="zola-anchor" href="#bei-jing" aria-label="Anchor link for: bei-jing">背景</a></h2>
<p>在<a href="https://www.titaneric.com/posts/grafana-loki-upgrade-1-zh/">前一篇Loki系列文章</a>中，提到我們利用金絲雀部署的方式，利用Vector複製真實環境的log送往新版Loki，在此同時調整Loki config進行效能調校，直到結果滿意之後，再開放給團隊使用。
因為我們的Loki是使用分散式模式部署，涉及多個功能不同的component，使得Loki架構非常複雜，在調整細項config之前，要非常清楚了解各個component間的關係，才能依序並且合理的調整config。</p>
<p>在調教Loki時，可以先針對<strong>寫入</strong>相關的component做調整，例如ingester及distributor，甚至是在前一篇文章中的提及的log collector，目標是<strong>讓寫入的chunk的Flush Reason盡可能是Full，避免碎片化chunk</strong>的問題。不僅能夠在空間上更有效率的存放，也同時能夠間接的影響query速度。</p>
<p>原因是相比於碎片化的chunk，滿載的chunk代表我們僅需更少數量的chunk，就能表示相同的log量，最終導致Loki在建立chunk的index也跟著減少。在查詢這些log時，Loki會依照query內容去查index，因為查到index後得知這些chunk數量是少的，也就花費更少的時間讀取chunk內容，讓querier可以專注在執行面，減少整體query時間開銷。</p>
<p>所以，我們花費大量的時間調校Loki的寫入效能，進而調整讀取效能，以下文章會分別針對寫入以及讀取，詳細說明各項config調整內容。</p>
<h2 id="loki-write-configdiao-zheng"><a class="zola-anchor" href="#loki-write-configdiao-zheng" aria-label="Anchor link for: loki-write-configdiao-zheng">Loki write config調整</a></h2>
<h3 id="ingester"><a class="zola-anchor" href="#ingester" aria-label="Anchor link for: ingester"><a rel="noreferrer" href="https://grafana.com/docs/loki/latest/configure/#ingester">ingester</a></a></h3>
<p><code>ingester.chunk-encoding</code>：直接設定成<code>snappy</code>，跟<code>gzip</code>相比雖然不是最大的壓縮比，但是速度較快，壓縮比也還能接受，<a rel="noreferrer" href="https://grafana.com/docs/loki/latest/configure/bp-configure/#use-snappy-compression-algorithm">官方config</a>以及<a rel="noreferrer" href="https://grafana.com/blog/2023/12/28/the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance/">官方blog</a>也推薦使用。</p>
<p><code>shard-streams.enabled</code>：在調整Loki labels後，stream數量會變少，但是每一條stream的log量會變大，可能會超過<code>ingester.per-stream-rate-limit</code>限制造成rate limit。開啟這個參數以後，如果某一條stream量超過<code>shard-streams.desired-rate</code>，會被分成多個stream shard，distributor會自動為這些stream shard加上<code>__stream_shard__</code> label，邏輯上會變成不同的stream，讓ingester有能力消化這些log。</p>
<p><code>ingester.per-stream-rate-limit</code>：如果開啟<code>shard-streams.enabled</code>還是會碰到rate limit，在ingester資源充足前提下，可以上調這個數值。</p>
<p><code>distributor.ingestion-rate-limit-mb</code>：可以參考<a rel="noreferrer" href="https://github.com/grafana/loki/blob/main/production/loki-mixin-compiled/dashboards/loki-operational.json">Loki Operational Dashboard</a>中MBs Per Tenant Panel裡的語法，並使用PromQL加總每一個tenant的log量，進而計算出合理的全局rate limit，<code>distributor.ingestion-burst-size-mb</code>需要也可以一併更新。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/9d552b04f6b44e3c87479a629f9cef4d.png?updatedAt=1750326304000" alt="" /></p>
<p><code>ingester.max-chunk-age</code>：雖然<a rel="noreferrer" href="https://grafana.com/blog/2021/02/16/the-essential-config-settings-you-should-use-so-you-wont-drop-logs-in-loki/">官方blog</a>曾建議將這個數值設定成<code>2h</code>，不過按照前一篇提及的方法調整過Loki labels後，我們將這數值上調到<code>4h</code>。同時，<code>ingester.chunks-idle-period</code>也調整成<code>4h</code>。我們刻意多等待2小時，讓一次性任務或是排程的log streams能利用這段時間寫到相同的chunk，讓Chunk Flush Reason更有機會從<strong>max age</strong>轉成<strong>full</strong>。另一個帶來的效益是如同<a rel="noreferrer" href="https://grafana.com/blog/2024/01/04/the-concise-guide-to-loki-how-to-work-with-out-of-order-and-older-logs/">官方 blog</a>提及的，我們能接受更早的out-of-order ingestion，這對我們非常有幫助，如果我們在Vector config有瑕疵，誤送一些錯誤處理的log到Loki去，多出來的這段時間能幫助我們排障，即時處理完後讓Loki不要因為out-of-order拒絕接受log。最後，雖然上調這個參數會小幅度的增加ingester記憶體使用，但這遠小於調整Loki labels節省的量，所以是可以接受的。</p>
<p><code>ingester.readiness-check-ring-health</code>：如果ingester的replica一多，在重啟 ingester statefulset時候預設會去檢查ingester ring上的健康程度，這時光是等待單顆ingester可能就消耗10分鐘，可以考慮將這數值改成false，僅檢查ingester自己的健康狀態，減少等待時間到<strong>2分鐘</strong>。</p>
<p><code>distributor.zone-awareness-enabled</code>：這個參數已經在<code>grafana/loki</code> helm chart的<code>ingester.zoneAwareReplication</code>有良好的封裝。如同以下例子，只要指定ingester的replica數量以及affinity，就能將不同的ingester<strong>平均</strong>部到不同的AZ，達成更高可用性的寫入。</p>
<pre data-lang="yaml" style="background-color:#fafafa;color:#61676c;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#399ee6;">ingester</span><span style="color:#61676ccc;">:
</span><span style="color:#399ee6;">replicas</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">12
</span><span style="color:#399ee6;">zoneAwareReplication</span><span style="color:#61676ccc;">:
</span><span>  </span><span style="color:#399ee6;">zoneA</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#399ee6;">extraAffinity</span><span style="color:#61676ccc;">:
</span><span>      </span><span style="color:#399ee6;">nodeAffinity</span><span style="color:#61676ccc;">:
</span><span>        </span><span style="color:#399ee6;">requiredDuringSchedulingIgnoredDuringExecution</span><span style="color:#61676ccc;">:
</span><span>          </span><span style="color:#399ee6;">nodeSelectorTerms</span><span style="color:#61676ccc;">:
</span><span>          - </span><span style="color:#399ee6;">matchExpressions</span><span style="color:#61676ccc;">:
</span><span>            - </span><span style="color:#399ee6;">key</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">nodepool
</span><span>              </span><span style="color:#399ee6;">operator</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">In
</span><span>              </span><span style="color:#399ee6;">values</span><span style="color:#61676ccc;">:
</span><span>              - </span><span style="color:#86b300;">loki
</span><span>            - </span><span style="color:#399ee6;">key</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">availability-zone
</span><span>              </span><span style="color:#399ee6;">operator</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">In
</span><span>              </span><span style="color:#399ee6;">values</span><span style="color:#61676ccc;">:
</span><span>              - </span><span style="color:#86b300;">az-1
</span><span>  </span><span style="color:#399ee6;">zoneB</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#61676ccc;">.</span><span style="color:#ff8f40;">..
</span><span>  </span><span style="color:#399ee6;">zoneC</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#61676ccc;">.</span><span style="color:#ff8f40;">..
</span></code></pre>
<h3 id="distributor"><a class="zola-anchor" href="#distributor" aria-label="Anchor link for: distributor"><a rel="noreferrer" href="https://grafana.com/docs/loki/latest/configure/#distributor">distributor</a></a></h3>
<p><code>distributor.client-cleanup-period</code>：在<a rel="noreferrer" href="https://grafana.com/docs/loki/latest/get-started/components/#rate-limiting">Loki架構</a>中，distributor會每隔一段時間，向ingester要每一條stream的log量，當作rate limit的參考。另外，distributor會每隔<code>distributor.client-cleanup-period</code>進行client的更新，移除不存在的ingester連線。在重啟ingester過程中，distributor如果沒有即時更新ingester連線，就有可能會誤送log給不存在的ingester。可以考慮縮減這段時間，更快移除這些不健康的連線避免錯誤。</p>
<p><code>distributor.rate-store.ingester-request-timeout</code>：如果因為網路的不穩定，造成distributor向ingester的請求時間較長造成timeout，可以稍微增加這個數值，避免distributor發生錯誤。</p>
<h2 id="loki-read-configdiao-zheng"><a class="zola-anchor" href="#loki-read-configdiao-zheng" aria-label="Anchor link for: loki-read-configdiao-zheng">Loki read config調整</a></h2>
<h3 id="querier"><a class="zola-anchor" href="#querier" aria-label="Anchor link for: querier"><a rel="noreferrer" href="https://grafana.com/docs/loki/latest/configure/#querier">querier</a></a></h3>
<p>關於Loki querier的調整可以直接參考<a rel="noreferrer" href="https://grafana.com/blog/2023/12/28/the-concise-guide-to-loki-how-to-get-the-most-out-of-your-query-performance/">官方blog</a>的詳細說明，作者特別使用精美的動畫說明querier相關的參數是如何影響query行為，也提供了各類metrics幫助Loki管理者發現當前問題。</p>
<p>在blog中，我覺得對調整最有幫助的是以下的LogQL語法(已依據使用情境做些調整)。</p>
<pre style="background-color:#fafafa;color:#61676c;"><code><span>{component=&quot;querier&quot;, cluster=&quot;$cluster&quot;, namespace=&quot;$namespace&quot;} 
</span><span>  |= &quot;metrics.go&quot; 
</span><span>  | logfmt
</span><span>  | latency=&quot;slow&quot;
</span><span>  | query_type=&quot;metric&quot; or query_type=&quot;filter&quot; or query_type=&quot;limited&quot;
</span><span>  | label_format 
</span><span>      duration_s=`{{.duration | duration}}`,
</span><span>      queue_time_s=`{{.queue_time | duration}}`,
</span><span>      chunk_refs_s=`{{.chunk_refs_fetch_time | duration}}`,
</span><span>      chunk_total_s=`{{.store_chunks_download_time | duration}}`,
</span><span>      cache_download_chunk_s=`{{.cache_chunk_download_time | duration}}`
</span><span>  | label_format total_time_s=`{{addf .queue_time_s .duration_s}}`
</span><span>  | label_format        
</span><span>      queue_pct=`{{mulf (divf .queue_time_s .total_time_s) 100 }}`,
</span><span>      index_pct=`{{mulf (divf (.chunk_refs_fetch_time | duration) .total_time_s) 100 }}`,
</span><span>      chunks_pct=`{{mulf (divf .chunk_total_s .total_time_s) 100}}`,
</span><span>      execution_pct=`{{mulf (divf (subf .duration_s .chunk_refs_s .chunk_total_s) .total_time_s) 100}}`,
</span><span>      cache_download_pct=`{{mulf (divf .cache_download_chunk_s .chunk_total_s) 100}}`,
</span><span>      avg_chunk_size=`{{divf (divf (bytes .total_bytes) .cache_chunk_req 1000)}}`
</span><span>  | line_format `| total_time {{printf &quot;%3.0f&quot; (.total_time_s | float64)}}s | queued {{printf &quot;%3.0f&quot; (.queue_pct | float64)}}% | execution {{printf &quot;%3.0f&quot; (.execution_pct | float64)}}% | index {{printf &quot;%3.0f&quot; (.index_pct | float64)}}% | store {{printf &quot;%3.0f&quot; (.chunks_pct | float64)}}% (cache {{ printf &quot;%3.0f&quot; (.cache_download_pct | float64) }}%) | avg_chunk {{printf &quot;%3.0f&quot; (.avg_chunk_size | float64)}}kB | {{ .query }}`
</span></code></pre>
<p>他會呈現發生slow query（執行時間大於10秒）時，querier在執行subquery時，在4個不同的phase所花費的時間:</p>
<p><strong>queued</strong>：在queue中等待的時間</p>
<p><strong>index</strong>：根據Loki label查index花費時間</p>
<p><strong>store</strong>：拿到index後，從cache或object storage拿chunk時間</p>
<p><strong>execution</strong>：取得chunk後，在querier中執行的時間</p>
<p>我們應盡可能讓<strong>execution</strong>比率愈高愈好（超過80%），因為這代表querier真正花費CPU時間計算結果，而不是在等待IO，如果發現query時間花在其他的phase，blog也有提到如何做對應的調整，在此不再贅述。</p>
<p>除此之外，我們特別調整<strong>store</strong>的呈現，多一個<strong>cache</strong>代表querier在拿chunk時，在cache中花費的時間，這個比率應該盡可能接近100%，代表拿chunk的時間主要花費在更快的cache，而不是慢得多的object storage。這對我們非常有幫助，讓我們發現先前的chunk cache是非常沒有效率的，需要額外調校，在之後會說明。</p>
<h3 id="chunk-cache"><a class="zola-anchor" href="#chunk-cache" aria-label="Anchor link for: chunk-cache"><a rel="noreferrer" href="https://grafana.com/docs/loki/latest/configure/#chunk_store_config">chunk cache</a></a></h3>
<p>如果有讀過<a rel="noreferrer" href="https://grafana.com/blog/2023/08/23/how-we-scaled-grafana-cloud-logs-memcached-cluster-to-50tb-and-improved-reliability/">這篇官方blog</a>，一定會覺得如果Loki的chunk cache改成Memcached，並使用<code>extstore</code>掛載快速的SSD，能用更多的空間以及相對便宜的成本，為Loki query帶來極高的效能。我們也像文章中一樣嘗試計算現有的LogQL查詢區間熱區，文章中並沒有提及實際的query語法，不過我們是使用以下LogQL搭配熱力圖呈現。</p>
<pre style="background-color:#fafafa;color:#61676c;"><code><span>sum_over_time({cluster=&quot;$cluster&quot;, namespace=&quot;$namespace&quot;, app=&quot;loki&quot;, component=&quot;query-frontend&quot;} |= &quot;metrics.go&quot; 
</span><span>  |= &quot;query_type&quot; | logfmt | query_type=&quot;metric&quot; or query_type=&quot;filter&quot; or query_type=&quot;limited&quot; 
</span><span>  | unwrap duration(start_delta)[5m])
</span></code></pre>
<p>由下圖可以看到，大部分的查詢區間都落在過去9小時以內。在討論後我們最後決定cache應至少能保留過去一天的chunk，進而計算cache需要的空間。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/8df2bccc2f424c3e9be76978042895e2.png?updatedAt=1750326446000" alt="" /></p>
<p>當時我們舊的Loki是使用Redis當作chunk cache，剛好目前的<code>grafana/loki</code> helm chart已經針對Memcached有良好封裝，我們決定直接為新的Loki套用這些設定。然而，我們發現結果不如預期。</p>
<p>利用前述的LogQL語法，我們發現querier花了30%以上的時間在<strong>store</strong> phase，而且我們特別新增的<strong>cache</strong> phase比率不到50%，這代表我們不僅花費時間在等待chunk下載，而且在cache以及object storage都耗費了大量時間。這與我們預期的接近100% <strong>cache</strong> phase比率及極少的<strong>store</strong> phase比率大相徑庭。</p>
<p>在<a rel="noreferrer" href="https://community.grafana.com/t/enabling-loki-jaeger-tracing/51483">開啟Loki的Jaeger tracing功能</a>以後，我們發現querier光是拿chunk cache花了超過10s，再加上<strong>execution</strong> phase所花費時間，經常會遇到timeout問題。</p>
<p>我們最終很幸運地在<a rel="noreferrer" href="https://github.com/memcached/memcached/wiki/ConfiguringLokiExtstore">memcached官方GitHub</a>找到解方，以下是官方建議的memcached設定：
讓<code>ingester.chunk-target-size</code> 以及在memcached的max item size (<code>-I</code>參數)不要太大，可以設定成<code>2MB</code>，同時在memcached加上extstore特別的參數。</p>
<pre data-lang="bash" style="background-color:#fafafa;color:#61676c;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#f29718;">memcached</span><span style="color:#ff8f40;"> -m</span><span> 6000</span><span style="color:#ff8f40;"> -I</span><span> 2m </span><span style="color:#61676ccc;">\
</span><span style="color:#ff8f40;">	-o</span><span> ext_path=/disk/extstore:500G,ext_wbuf_size=32,ext_threads=10,ext_max_sleep=10000,slab_automove_freeratio=0.10,ext_recache_rate=0
</span></code></pre>
<p>另外在loki設定中，應設定不大的batch size及parallelism，並且拉高timeout。</p>
<p><code>store.chunks-cache.memcached.batchsize</code>意思是memcached client一次拿多少個memcached keys，可以設定成memcached server的2倍數量。</p>
<p><code>store.chunks-cache.memcached.parallelism</code>目的是同時有多少的go routine是取得memcached keys，盡可能設定愈低的值，但如果網路頻寬允許的話可以拉高。</p>
<p><code>store.chunks-cache.memcached.timeout</code>的時間包含memcached拿cache，以及serialization的時間，如果chunk的item size一大，或是batch size大的話會影響timeout時間。預設是<code>100ms</code>但強烈建議調整成較高的值例如<code>60s</code>。</p>
<blockquote>
<p>Loki's memcache client timeout is measuring the amount of time to <em>fetch and read and process the entire batch of keys from each host</em>.</p>
</blockquote>
<p><code>store.background.write-back-concurrency</code>代表寫入memcached的go routine數量，建議調整成1，避免太積極地寫入memcached，造成一些item被evict。</p>
<pre data-lang="yml" style="background-color:#fafafa;color:#61676c;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#399ee6;">chunk_store_config</span><span style="color:#61676ccc;">:
</span><span style="color:#399ee6;">chunk_cache_config</span><span style="color:#61676ccc;">:
</span><span>  </span><span style="color:#399ee6;">memcached</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#399ee6;">batch_size</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">3
</span><span>    </span><span style="color:#399ee6;">parallelism</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">2
</span><span>  </span><span style="color:#399ee6;">memcached_client</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#399ee6;">addresses</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">127.0.0.1:11211
</span><span>    </span><span style="color:#399ee6;">timeout</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">60s
</span><span>  </span><span style="color:#399ee6;">background</span><span style="color:#61676ccc;">:
</span><span>    </span><span style="color:#399ee6;">writeback_goroutines</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">1
</span><span>    </span><span style="color:#399ee6;">writeback_buffer</span><span style="color:#61676ccc;">: </span><span style="color:#ff8f40;">1000
</span><span>    </span><span style="color:#399ee6;">writeback_size_limit</span><span style="color:#61676ccc;">: </span><span style="color:#86b300;">500MB
</span></code></pre>
<h2 id="cheng-guo"><a class="zola-anchor" href="#cheng-guo" aria-label="Anchor link for: cheng-guo">成果</a></h2>
<h3 id="write-performance"><a class="zola-anchor" href="#write-performance" aria-label="Anchor link for: write-performance">Write performance</a></h3>
<p>在下圖中，可以看到因為ingester在寫入log效能足夠，搭配適當的調節distributor的rate limit以及shard-streams，讓Loki不再因為rate limit問題，在distributor端拋棄送進來的log。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/9b3cf57812b44d2dab95e0dc953a2047.png?updatedAt=1750326529000" alt="" /></p>
<h3 id="query-performance"><a class="zola-anchor" href="#query-performance" aria-label="Anchor link for: query-performance">Query performance</a></h3>
<p>下圖是在前面的介紹到修改過後的官方LogQL執行結果，可以看到就算是slow subquery的執行，在<strong>execution</strong> phase執行時間佔比還是高達90%以上，而且在<strong>cache</strong>部分的佔比，更高達95%以上，這印證了chunk主要從cache中拿到，省下來的時間可以執行計算LogQL最後結果。</p>
<p>事實上在<strong>execution</strong> phase還有調整的空間，有機會透過增加querier replicas數量、調升CPU資源或是改善LogQL語法來更近一步加速搜尋時間。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/0bd7beb9a0124ea0bda1d474e06d1577.png?updatedAt=1750326541000" alt="" /></p>
<p>下方是query花費時間隨時間的關係圖。黃線是第99百分位、橘線是第90百分位。可以看到query時間絕大部分都少於10s。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/2596fdc70a26474ab054f0f1e2713906.png?updatedAt=1750326553000" alt="" /></p>
<h3 id="cache-performance"><a class="zola-anchor" href="#cache-performance" aria-label="Anchor link for: cache-performance">Cache performance</a></h3>
<p>在chunk cache部分，hit rate大部分時間都維持70%以上，這樣Loki可以避免再向慢得多的Object Storage拿需要的chunk，也減輕Object Storage的負擔。</p>
<p><img src="https://vos.line-scdn.net/landpress-content-v2-vcfc68aynwenkh3bno0ixfx8/5b6c5c0beb504dceb2a4d8e3de6fe7af.png?updatedAt=1750326563000" alt="" /></p>
<h2 id="jie-lun"><a class="zola-anchor" href="#jie-lun" aria-label="Anchor link for: jie-lun">結論</a></h2>
<p>在這篇文章中，我們將重點著重在Loki的config調整。先是說明為何應該優先調整寫入效能，因為會連帶影響讀取效能。再帶到在Loki中負責寫入以及讀取的component細節config設定。過程中特別感謝Grafana以及Memcached提供的技術文章，提供給我們調整上的指引。</p>
<p>最後的成效是在寫入時，能盡可能接收log collector送來的log，在查詢上也能充分應用cache，減少Object Storage負擔，效果是令人滿意的。我們今後也會持續針對log collector以及Loki效能做精進，提供Loki的使用者更好的使用者體驗。</p>

            </section>
        </article>
    </main>
</div>



            
                
            

            
        </div>

        <div class="right-content">
            
    
    
        <div class="toc">
    <div class="heading">Table of Contents</div>
    <ul class="toc-list">
        
            <li class="parent">
                
                <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#bei-jing">背景</a>

                
            </li>
        
            <li class="parent">
                
                <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#loki-write-configdiao-zheng">Loki write config調整</a>

                
                    <ul>
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#ingester">ingester</a>
                        </li>

                        
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#distributor">distributor</a>
                        </li>

                        
                    
                    </ul>
                
            </li>
        
            <li class="parent">
                
                <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#loki-read-configdiao-zheng">Loki read config調整</a>

                
                    <ul>
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#querier">querier</a>
                        </li>

                        
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#chunk-cache">chunk cache</a>
                        </li>

                        
                    
                    </ul>
                
            </li>
        
            <li class="parent">
                
                <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#cheng-guo">成果</a>

                
                    <ul>
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#write-performance">Write performance</a>
                        </li>

                        
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#query-performance">Query performance</a>
                        </li>

                        
                    
                        
                        <li>
                            <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#cache-performance">Cache performance</a>
                        </li>

                        
                    
                    </ul>
                
            </li>
        
            <li class="parent">
                
                <a href="https://www.titaneric.com/posts/grafana-loki-upgrade-2-zh/#jie-lun">結論</a>

                
            </li>
        
    </ul>
</div>

    

        </div>
    </body>

</html>
